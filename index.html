<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 아기 얼굴 예측 프로그램</title>
    <!-- Cache buster: 2025-09-19-14:30 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@polar-sh/sdk@latest/dist/index.umd.js"></script>
    <style>
        /* 기본 & 폰트 설정 */
        :root {
            --color-primary: #4f46e5;
            --color-primary-hover: #4338ca;
            --color-secondary: #10b981;
            --color-background: #f9fafb;
            --color-surface: #ffffff;
            --color-text-primary: #1f2937;
            --color-text-secondary: #6b7280;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            margin: 0;
        }

        /* 레이아웃 */
        .container-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 80rem; /* Increased max-width */
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .main-card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
            padding: 1.5rem;
        }

        /* 헤더 */
        h1 {
            font-size: 2.25rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            letter-spacing: -0.025em;
        }
        h1 .fa-baby {
            color: #ec4899;
        }
        h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* API 키 섹션 */
        #api-key-section {
            padding: 2rem;
            margin-bottom: 2rem;
        }
        #api-key-section .fa-key { color: var(--color-primary); }
        #api-key-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #api-key-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        #save-api-key {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #save-api-key:hover {
            background-color: var(--color-primary-hover);
        }

        /* 모드 선택 버튼 */
        .mode-selector {
            display: flex;
            justify-content: center;
            background-color: #e5e7eb;
            padding: 0.375rem;
            border-radius: 9999px;
            width: 100%;
            max-width: 24rem;
            margin: 0 auto 2rem auto;
        }
        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            color: var(--color-text-secondary);
        }
        .mode-btn.active {
            background-color: var(--color-surface);
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        /* 업로드 섹션 */
        .upload-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-bottom: 2rem; }
        @media (min-width: 1024px) { .upload-grid { grid-template-columns: 1fr 1fr; } }
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            transition: border-color 0.2s;
        }
        .upload-area:hover { border-color: var(--color-primary); }
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
        }
        .upload-label .fa-cloud-upload-alt { color: #9ca3af; font-size: 2.25rem; margin-bottom: 1rem; }
        .hidden { display: none; }
        .preview-container {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .preview-item {
            position: relative;
            background: #f3f4f6;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .preview-content { padding: 0.5rem; }
        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .remove-btn:hover { background-color: rgba(239, 68, 68, 0.8); }

        /* 설정 섹션 */
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border); }
        @media (min-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; gap: 2.5rem; } }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .radio-input {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            margin-right: 0.5rem;
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s;
        }
        .radio-input:checked { border-color: var(--color-primary); }
        .radio-input:checked::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: var(--color-primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .generation-btn-group { display: flex; gap: 0.5rem; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
        .generation-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: none;
            background-color: transparent;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .generation-btn.active { background-color: white; color: var(--color-primary); box-shadow: var(--shadow-sm); }
        
        .preset-age-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border);
            background-color: white;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preset-age-btn.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-lg);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-lg);
        }
        
        .prediction-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .prediction-option input[type="radio"] { margin-right: 1rem; }
        .prediction-option:has(input:checked) {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }

        #face-visualizer { background-color: #f9fafb; border-radius: 0.5rem; box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); padding: 1rem; min-height: 16rem; display: flex; align-items: center; justify-content: center; }
        .feature-highlight { opacity: 0; transition: opacity 0.3s; fill: transparent; }
        .feature-highlight.active { opacity: 0.5; }
        .detailed-slider-item { padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .detailed-slider-item.highlighted { background-color: #eff6ff; }
        .detailed-slider-label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .detailed-percentages { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem; }

        /* 생성 버튼 */
        .generate-button {
            padding: 0.875rem 2rem;
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-lg);
            display: inline-flex;
            align-items: center;
        }
        .generate-button:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        .generate-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
        }
        #error-message { color: #ef4444; margin-top: 1rem; font-weight: 500; }

        /* 결과 모달 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text-secondary);
            border: none;
            background: none;
            cursor: pointer;
        }
        .loading-state, .error-state { text-align: center; padding: 2rem; }
        .spinner {
            width: 56px;
            height: 56px;
            border: 5px solid var(--color-border);
            border-bottom-color: var(--color-primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .results-grid {
            display: grid;
            gap: 1.5rem;
        }
        .results-grid.multiple { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .results-grid.single { display: flex; justify-content: center; }
        .results-grid.single .result-item { max-width: 512px; }
        
        .result-item { background-color: #f9fafb; border-radius: var(--border-radius); overflow: hidden; }
        .result-image { width: 100%; display: block; }
        .download-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            background-color: var(--color-primary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .download-btn:hover { background-color: var(--color-primary-hover); }

        /* 초음파 비교 결과 스타일 */
        .ultrasound-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        .ultrasound-comparison .comparison-section {
            background-color: #f9fafb;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }
        .ultrasound-comparison .comparison-header {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .ultrasound-comparison .comparison-image {
            width: 100%;
            display: block;
            aspect-ratio: 1;
            object-fit: cover;
        }
        .ultrasound-comparison .comparison-footer {
            padding: 0.75rem;
            text-align: center;
        }
        .ultrasound-comparison .download-btn {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .modal-actions { margin-top: 1.5rem; text-align: center; }
        .btn-secondary {
            padding: 0.5rem 1rem;
            background: var(--color-border);
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        /* 인증 관련 스타일 */
        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-border);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .auth-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-primary);
            background: transparent;
            color: var(--color-primary);
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .auth-btn.primary {
            background: var(--color-primary);
            color: white;
        }
        .auth-btn:hover {
            background: var(--color-primary);
            color: white;
        }
        .social-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }
        .social-login-btn:hover {
            background: #f9fafb;
            border-color: var(--color-primary);
        }
        .divider {
            display: flex;
            align-items: center;
            margin: 1rem 0;
            color: var(--color-text-secondary);
            font-size: 0.875rem;
        }
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }
        .divider span {
            padding: 0 1rem;
        }

        /* 구매 관련 스타일 */
        .purchase-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .purchase-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .purchase-btn.buy-now {
            background: var(--color-secondary);
            color: white;
        }
        .purchase-btn.buy-now:hover {
            background: #059669;
        }
        .purchase-btn.add-cart {
            background: white;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }
        .purchase-btn.add-cart:hover {
            background: var(--color-primary);
            color: white;
        }
        .purchase-btn.remove {
            background: #ef4444;
            color: white;
        }
        .purchase-btn.remove:hover {
            background: #dc2626;
        }
        .purchase-btn.cancel {
            background: #6b7280;
            color: white;
        }
        .purchase-btn.cancel:hover {
            background: #4b5563;
        }

        /* Status badges for order history */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-pending {
            background: #fbbf24;
            color: #92400e;
        }
        .status-processing {
            background: #60a5fa;
            color: #1e40af;
        }
        .status-completed {
            background: #34d399;
            color: #065f46;
        }
        .status-failed {
            background: #f87171;
            color: #dc2626;
        }
        .status-refunded {
            background: #a78bfa;
            color: #5b21b6;
        }
        .status-cancelled {
            background: #6b7280;
            color: #374151;
        }

        .price-tag {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-secondary);
            margin-bottom: 0.5rem;
        }

        /* 장바구니 플로팅 버튼 */
        .cart-floating {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: var(--shadow-xl);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 50;
        }
        .cart-floating:hover {
            transform: scale(1.1);
            background: var(--color-primary-hover);
        }
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            min-width: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-wrapper">
        <div class="container">
            <!-- Auth Header -->
            <div class="auth-header" id="auth-header">
                <div class="user-info" id="user-info" style="display: none;">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div>
                        <div id="user-name" style="font-weight: 600; font-size: 0.875rem;">사용자</div>
                        <div id="user-email" style="font-size: 0.75rem; color: var(--color-text-secondary);">user@example.com</div>
                    </div>
                </div>
                <div class="auth-buttons" id="auth-buttons">
                    <button id="login-btn" class="auth-btn">로그인</button>
                    <button id="signup-btn" class="auth-btn primary">회원가입</button>
                </div>
                <div class="auth-buttons" id="user-menu" style="display: none;">
                    <button id="cart-btn" class="auth-btn">
                        <i class="fas fa-shopping-cart"></i> 장바구니 (<span id="cart-count">0</span>)
                    </button>
                    <button id="queue-btn" class="auth-btn">처리 현황</button>
                    <button id="orders-btn" class="auth-btn">구매 이력</button>
                    <button id="logout-btn" class="auth-btn">로그아웃</button>
                </div>
            </div>

            <!-- Header -->
            <header style="position: relative;">
                <!-- Service Status -->
                <div id="service-status" style="position: absolute; top: 0; left: 0; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; background-color: #10b981; color: white;">
                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                    <span id="service-status-text">Service On</span>
                </div>

                <h1>
                    <i class="fas fa-baby"></i>
                    AI 아기 얼굴 예측 프로그램
                </h1>
                <p style="margin-top: 0.75rem; font-size: 1.125rem; color: var(--color-text-secondary);">당신의 미래 아기는 어떤 모습일까요?</p>
            </header>


            <!-- Main App -->
            <main id="main-app" class="main-card">

                <!-- Upload Mode Selection -->
                <div class="mb-8">
                    <h3>사진을 어떻게 업로드 하시겠어요?</h3>
                    <div class="mode-selector" style="max-width: 36rem;">
                        <button id="ultrasound-mode" class="mode-btn">초음파 사진</button>
                        <button id="separate-mode" class="mode-btn active">부모님 각각</button>
                        <button id="together-mode" class="mode-btn">부모님 함께</button>
                    </div>
                </div>

                <!-- Photo Upload Sections -->
                <div id="ultrasound-upload" style="max-width: 42rem; margin: 0 auto 2rem auto; display: none;">
                    <div class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">초음파 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="ultrasound-files" multiple accept="image/*" class="hidden">
                            <label for="ultrasound-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">초음파 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">아기의 3D/4D 초음파 사진을 업로드하세요</span>
                            </label>
                        </div>
                        <div id="ultrasound-previews" class="preview-container"></div>
                    </div>
                </div>

                <div id="separate-upload" class="upload-grid">
                    <div id="father-upload" class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">아빠 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="father-files" multiple accept="image/*" class="hidden">
                            <label for="father-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">아빠 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="father-previews" class="preview-container"></div>
                    </div>

                    <div id="mother-upload" class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">엄마 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="mother-files" multiple accept="image/*" class="hidden">
                            <label for="mother-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">엄마 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="mother-previews" class="preview-container"></div>
                    </div>
                </div>

                <div id="together-upload" style="max-width: 42rem; margin: 0 auto 2rem auto; display: none;">
                    <div class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">부모님이 함께 나온 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="together-files" multiple accept="image/*" class="hidden">
                            <label for="together-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">부모님 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="together-previews" class="preview-container"></div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-grid">
                    <!-- Family Details -->
                    <div class="space-y-6">
                        <h3 style="text-align: left;">가족 정보 설정</h3>

                        <!-- Baby Info -->
                        <div style="space-y: 1rem; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                            <h4 style="font-weight: 500; color: var(--color-text-secondary); font-size: 0.875rem;">아기 정보</h4>
                            <div>
                                <label for="child-number" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">몇 번째 아이인가요?</label>
                                <input type="number" id="child-number" value="1" min="1" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">성별</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="gender" value="Male" class="radio-input">
                                        <span>남자</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="gender" value="Female" checked class="radio-input">
                                        <span>여자</span>
                                    </label>
                                </div>
                            </div>
                             <div>
                                <label for="ethnicity" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">인종</label>
                                <input type="text" id="ethnicity" class="form-input" placeholder="예: 동아시아인, 백인">
                            </div>
                            <div>
                                <label for="nationality" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">국적</label>
                                <input type="text" id="nationality" class="form-input" placeholder="예: 한국인, 미국인">
                            </div>

                            <!-- Generation Mode -->
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.5rem;">생성 옵션</label>
                                <div class="generation-btn-group">
                                    <button id="single-age-btn" class="generation-btn active">특정 나이</button>
                                    <button id="age-progression-btn" class="generation-btn">성장 과정</button>
                                </div>
                            </div>

                            <!-- Single Age Options -->
                            <div id="single-age-options">
                                <div style="margin-bottom: 1rem;">
                                    <label for="baby-age" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">나이</label>
                                    <select id="baby-age" class="form-input">
                                        <option value="Newborn">신생아</option>
                                        <option value="1 year old">1살</option>
                                        <option value="2 years old">2살</option>
                                        <option value="custom">직접 입력</option>
                                    </select>
                                    <div id="custom-age-input" style="display: none;">
                                        <input type="number" id="custom-age" placeholder="나이를 숫자로 입력" class="form-input" style="margin-top: 0.5rem;">
                                    </div>
                                </div>
                                <div>
                                    <label for="num-images" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">생성할 사진 수 (1-4)</label>
                                    <input type="number" id="num-images" value="1" min="1" max="4" class="form-input">
                                </div>
                            </div>

                            <!-- Age Progression Options -->
                            <div id="age-progression-options" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">생성할 나이 선택</label>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">원하는 나이를 모두 선택하세요.</p>
                                    <div id="preset-ages" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <!-- Preset age buttons will be inserted here -->
                                    </div>
                                </div>
                                <div>
                                    <label for="age-progression-count" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">나이별 사진 수 (1-2)</label>
                                    <input type="number" id="age-progression-count" value="1" min="1" max="2" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Type -->
                    <div class="space-y-4">
                        <h3 style="text-align: left;">닮은꼴 설정</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background-color: #f3f4f6; border-radius: 0.5rem;">
                            <label class="prediction-option">
                                <input type="radio" name="comparison-type" value="simple" checked>
                                <div>
                                    <span style="font-weight: 500;">단순 설정</span>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary);">전체적으로 누구를 닮을지 비율로 조절합니다.</p>
                                </div>
                            </label>
                            <label class="prediction-option">
                                <input type="radio" name="comparison-type" value="detailed">
                                <div>
                                    <span style="font-weight: 500;">상세 설정</span>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary);">눈, 코, 입 등 부위별로 닮은 정도를 조절합니다.</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                            <div id="simple-resemblance">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.5rem;">전체적인 닮음</label>
                                <input type="range" id="simple-slider" min="0" max="100" value="50" class="slider">
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem;">
                                    <span id="dad-percentage">아빠: 50%</span>
                                    <span id="mom-percentage">엄마: 50%</span>
                                </div>
                            </div>
    
                            <div id="detailed-resemblance" style="display: none;">
                                <div id="detailed-sliders" style="space-y: 0.75rem; max-height: 20rem; overflow-y: auto; padding-right: 0.5rem;">
                                    <!-- Detailed sliders will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Facial Feature Visualizer -->
                        <div id="face-visualizer" style="display: none;">
                            <svg id="face-svg" viewBox="0 0 200 200" style="width: 100%; max-width: 16rem; aspect-ratio: 1 / 1;">
                                <!-- Face base -->
                                <path d="M 100, 190 C 40, 190, 10, 150, 10, 100 C 10, 50, 40, 10, 100, 10 C 160, 10, 190, 50, 190, 100 C 190, 150, 160, 190, 100, 190 Z" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />

                                <!-- Highlight areas -->
                                <g id="highlight-areas">
                                    <path id="forehead-highlight" d="M 40, 60 Q 100, 30, 160, 60 L 160, 20 Q 100, 5, 40, 20 Z" class="feature-highlight" />
                                    <path id="eyebrows-highlight" d="M 55, 65 Q 75, 60, 95, 65 L 105, 65 Q 125, 60, 145, 65 L 140, 75 Q 125, 70, 110, 75 L 90, 75 Q 75, 70, 60, 75 Z" class="feature-highlight" />
                                    <path id="glabella-highlight" d="M 90, 80 L 110, 80 L 110, 95 L 90, 95 Z" class="feature-highlight" />
                                    <ellipse id="eyes-highlight" cx="100" cy="90" rx="45" ry="12" class="feature-highlight" />
                                    <path id="underEyes-highlight" d="M 55, 100 Q 100, 108, 145, 100 L 140, 105 Q 100, 113, 60, 105 Z" class="feature-highlight" />
                                    <path id="temples-highlight" d="M 20, 70 L 40, 70 L 40, 130 L 20, 130 Z M 160, 70 L 180, 70 L 180, 130 L 160, 130 Z" class="feature-highlight" />
                                    <path id="nose-highlight" d="M 90, 100 L 110, 100 L 105, 135 L 95, 135 Z" class="feature-highlight" />
                                    <path id="nasolabialArea-highlight" d="M 80, 120 Q 90, 140, 85, 150 L 75, 150 Q 80, 135, 70, 120 Z M 120, 120 Q 110, 140, 115, 150 L 125, 150 Q 120, 135, 130, 120 Z" class="feature-highlight" />
                                    <path id="cheeks-highlight" d="M 40, 110 C 60, 150, 80, 150, 80, 120 L 40, 110 Z M 160, 110 C 140, 150, 120, 150, 120, 120 L 160, 110 Z" class="feature-highlight" />
                                    <path id="cheekbones-highlight" d="M 30, 90 C 50, 100, 70, 110, 70, 90 Z M 170, 90 C 150, 100, 130, 110, 130, 90 Z" class="feature-highlight" />
                                    <path id="mouth-highlight" d="M 80, 155 Q 100, 165, 120, 155 Q 100, 170, 80, 155 Z" class="feature-highlight" />
                                    <path id="jawline-highlight" d="M 50, 160 C 100, 190, 150, 160, 150, 160 L 100, 195 Z" class="feature-highlight" />
                                    <path id="ears-highlight" d="M 25, 80 Q 5, 100, 25, 120 L 20, 120 Q 0, 100, 20, 80 Z M 175, 80 Q 195, 100, 175, 120 L 180, 120 Q 200, 100, 180, 80 Z" class="feature-highlight" />
                                </g>

                                <!-- Facial features -->
                                <g id="facial-features">
                                    <path d="M 25, 80 Q 5, 100, 25, 120" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />
                                    <path d="M 175, 80 Q 195, 100, 175, 120" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />
                                    <ellipse cx="75" cy="90" rx="15" ry="10" fill="white" stroke="#4A4A4A" stroke-width="1.5" />
                                    <circle cx="75" cy="90" r="5" fill="#4A4A4A" />
                                    <ellipse cx="125" cy="90" rx="15" ry="10" fill="white" stroke="#4A4A4A" stroke-width="1.5" />
                                    <circle cx="125" cy="90" r="5" fill="#4A4A4A" />
                                    <path d="M 60, 70 Q 75, 65, 90, 70" fill="none" stroke="#4A4A4A" stroke-width="2.5" stroke-linecap="round" />
                                    <path d="M 110, 70 Q 125, 65, 140, 70" fill="none" stroke="#4A4A4A" stroke-width="2.5" stroke-linecap="round" />
                                    <path d="M 95, 110 C 100, 115, 105, 115, 105, 110" fill="none" stroke="#4A4A4A" stroke-width="1.5" stroke-linecap="round" />
                                    <path d="M 85, 155 Q 100, 160, 115, 155" fill="none" stroke="#4A4A4A" stroke-width="2" stroke-linecap="round" />
                                </g>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; padding-top: 2rem; border-top: 1px solid var(--color-border);">
                    <button id="generate-btn" class="generate-button" disabled>
                        <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
                        <span>아기 얼굴 예측하기</span>
                    </button>
                    <div id="error-message" style="display: none;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-confirmation" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-baby" style="color: #ec4899; font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">생성 요청 확인</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">아래 설정이 맞는지 확인해주세요.</p>
            </div>

            <div id="request-summary" style="background-color: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--color-border);">
                <!-- Summary content will be inserted here -->
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button id="cancel-generation" class="btn-secondary" style="padding: 0.75rem 1.5rem; font-weight: 500;">
                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>취소
                </button>
                <button id="add-to-cart-generation" class="btn-secondary" style="padding: 0.75rem 1.5rem; font-weight: 500; background: var(--color-primary); color: white; border: 1px solid var(--color-primary);">
                    <i class="fas fa-cart-plus" style="margin-right: 0.5rem;"></i>장바구니
                </button>
                <button id="confirm-generation" class="generate-button" style="padding: 0.75rem 2rem;">
                    <i class="fas fa-credit-card" style="margin-right: 0.5rem;"></i>즉시 결제 및 생성
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-modal" class="modal-close">&times;</button>
            <div id="result-container">
                <!-- Loading state -->
                <div id="loading-state" class="loading-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: var(--color-text-secondary); font-weight: 500;">AI가 아기의 얼굴을 만들고 있어요...</p>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 0.25rem;">잠시만 기다려주세요.</p>
                </div>

                <!-- Error state -->
                <div id="error-state" class="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 2.25rem; margin-bottom: 1rem;"></i>
                    <p style="font-weight: bold; color: #ef4444;">이미지 생성 실패</p>
                    <p id="error-details" style="font-size: 0.875rem; margin-top: 0.25rem; color: #f87171; white-space: pre-wrap;"></p>
                </div>

                <!-- Results -->
                <div id="results-grid" style="display: none;">
                    <!-- Generated images will be inserted here -->
                </div>
            </div>

            <div class="modal-actions">
                <button id="close-results" class="btn-secondary">닫기</button>
            </div>
        </div>
    </div>

    <!-- Auth Modals -->
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-login" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-sign-in-alt" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">로그인</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">계정에 로그인하세요</p>
            </div>

            <form id="login-form">
                <button type="button" id="google-login" class="social-login-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google로 로그인
                </button>

                <div class="divider">
                    <span>또는</span>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">이메일</label>
                    <input type="email" id="login-email" class="form-input" placeholder="이메일을 입력하세요" required>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">비밀번호</label>
                    <input type="password" id="login-password" class="form-input" placeholder="비밀번호를 입력하세요" required>
                    <div style="text-align: right; margin-top: 0.5rem;">
                        <button type="button" id="forgot-password-link" style="color: var(--color-primary); background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 0.75rem;">비밀번호를 잊으셨나요?</button>
                    </div>
                </div>

                <button type="submit" class="generate-button" id="login-submit-btn" style="width: 100%; margin-bottom: 1rem;">
                    <i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>로그인
                </button>

                <!-- 로그인 오류 메시지를 버튼 아래로 이동 -->
                <div id="login-error" style="display: none; color: #dc3545; font-size: 0.875rem; text-align: center; margin-bottom: 1rem; padding: 0.75rem; background-color: #fef2f2; border: 1px solid #fecaca; border-radius: 0.375rem;"></div>

                <div style="text-align: center; font-size: 0.875rem; color: var(--color-text-secondary);">
                    계정이 없으신가요? <button type="button" id="switch-to-signup" style="color: var(--color-primary); background: none; border: none; cursor: pointer; text-decoration: underline;">회원가입</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-signup" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-user-plus" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">회원가입</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">새 계정을 만드세요</p>
            </div>

            <form id="signup-form">
                <button type="button" id="google-signup" class="social-login-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google로 회원가입
                </button>

                <div class="divider">
                    <span>또는</span>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">이름</label>
                    <input type="text" id="signup-name" class="form-input" placeholder="이름을 입력하세요" required>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">이메일</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="이메일을 입력하세요" required>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">비밀번호</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="비밀번호를 입력하세요 (최소 6자)" required>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">비밀번호 확인</label>
                    <input type="password" id="signup-password-confirm" class="form-input" placeholder="비밀번호를 다시 입력하세요" required>
                </div>

                <!-- 개발자 모드 옵션 (숨김) -->
                <div id="dev-mode-options" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 0.375rem;">
                    <label style="display: flex; align-items: center; font-size: 0.75rem; color: #856404; cursor: pointer;">
                        <input type="checkbox" id="skip-email-verification" style="margin-right: 0.5rem;">
                        개발자 모드: 이메일 확인 없이 가입 (테스트용)
                    </label>
                    <p style="font-size: 0.625rem; color: #856404; margin: 0.25rem 0 0 1rem;">⚠️ 이 옵션은 개발/테스트 목적으로만 사용하세요</p>
                </div>

                <button type="submit" class="generate-button" style="width: 100%; margin-bottom: 1rem;">
                    <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>회원가입
                </button>

                <div style="text-align: center; font-size: 0.875rem; color: var(--color-text-secondary);">
                    이미 계정이 있으신가요? <button type="button" id="switch-to-login" style="color: var(--color-primary); background: none; border: none; cursor: pointer; text-decoration: underline;">로그인</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-forgot-password" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-key" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">비밀번호 찾기</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">가입 시 사용한 이메일을 입력하세요</p>
            </div>

            <form id="forgot-password-form">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">이메일</label>
                    <input type="email" id="forgot-email" class="form-input" placeholder="가입 시 사용한 이메일을 입력하세요" required>
                    <div id="forgot-error" style="display: none; color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem;"></div>
                </div>

                <button type="submit" class="generate-button" style="width: 100%; margin-bottom: 1rem;">
                    <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>비밀번호 재설정 이메일 전송
                </button>

                <div style="text-align: center; font-size: 0.875rem; color: var(--color-text-secondary);">
                    기억났나요? <button type="button" id="back-to-login" style="color: var(--color-primary); background: none; border: none; cursor: pointer; text-decoration: underline;">로그인</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-cart" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-shopping-cart" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">장바구니</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">구매할 이미지들을 확인하세요</p>
            </div>

            <div id="cart-items" style="max-height: 400px; overflow-y: auto;">
                <!-- Cart items will be inserted here -->
            </div>

            <div style="border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 1rem;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                    <span style="font-size: 1.125rem; font-weight: 600;">총 금액:</span>
                    <span id="cart-total" style="font-size: 1.25rem; font-weight: 700; color: var(--color-secondary);">$0.00</span>
                </div>
                <button id="checkout-btn" class="generate-button" style="width: 100%;" disabled>
                    <i class="fas fa-credit-card" style="margin-right: 0.5rem;"></i>결제하기
                </button>
            </div>
        </div>
    </div>

    <!-- Order History Modal -->
    <div id="orders-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-orders" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-history" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">구매 이력</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">구매한 이미지들을 확인하고 다운로드하세요</p>
            </div>

            <div id="orders-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Orders will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Processing Queue Modal -->
    <div id="queue-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-queue" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-tasks" style="color: var(--color-primary); font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">처리 대기열</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">아기 얼굴 생성 진행상황을 확인하세요</p>
            </div>

            <div id="queue-list" style="max-height: 500px; overflow-y: auto;">
                <!-- Queue items will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Floating Cart Button -->
    <button id="cart-floating" class="cart-floating" style="display: none;">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-floating-badge" class="cart-badge" style="display: none;">0</span>
    </button>

    <script>
        // AI Baby Face Predictor - Enhanced with Supabase Auth & Payment System
        class BabyFacePredictor {
            constructor() {
                // 관리자 API 키 (보안 관리) - async로 로드됨
                this.apiKey = null;
                this._cachedApiKey = undefined; // 캐시 초기화
                this.inputMode = 'separate';
                this.generationMode = 'singleAge';
                this.comparisonType = 'simple';

                // 서비스 상태 초기화
                this.serviceStatus = 'checking';

                // Supabase 설정 (환경변수 또는 설정 파일에서 가져와야 함)
                this.supabaseUrl = 'https://jxmufwpgbklmboxisrqj.supabase.co';
                this.supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4bXVmd3BnYmtsbWJveGlzcnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMDc2NzUsImV4cCI6MjA3MzY4MzY3NX0.pMFOnh6MSh-LmIMZpeWjJMo3qVRuh1HHNxVRsk8FFmU';

                // Supabase 클라이언트 초기화
                this.supabase = window.supabase.createClient(this.supabaseUrl, this.supabaseAnonKey);

                // Polar 클라이언트 초기화
                try {
                    this.polar = new window.Polar.Configuration({
                        accessToken: this.polarAccessToken,
                        server: "https://api.polar.sh"
                    });
                    this.polarApi = new window.Polar.ProductsApi(this.polar);
                    this.polarCheckoutApi = new window.Polar.CheckoutApi(this.polar);
                } catch (error) {
                    console.warn('Polar SDK not available, using fallback implementation');
                    this.polar = null;
                }

                // 현재 사용자
                this.currentUser = null;
                this.cartItems = [];
                this.isAuthenticated = false;

                // 이미지 저장소
                this.fatherImages = [];
                this.motherImages = [];
                this.togetherImages = [];
                this.ultrasoundImages = [];

                // 가격 설정 (센트 단위) - 한국돈 500원 = $0.40
                this.pricing = {
                    ultrasound: 40, // $0.40
                    separate: 40,   // $0.40
                    together: 40    // $0.40
                };

                // Polar 설정
                this.polarAccessToken = 'polar_oat_Y91yjD0lNDvonn7gnbns3ewR0ri5WPRfKQhCv258vXQ';

                // 설정
                this.settings = {
                    ethnicity: '',
                    nationality: '',
                    childNumber: 1,
                    gender: 'Female',
                    babyAge: 'Newborn',
                    customAge: '',
                    numberOfImages: 1,
                    ageProgressionCount: 1,
                    selectedPresetAges: [],
                    simplePercentages: { mom: 50, dad: 50 },
                    detailedPercentages: this.initializeDetailedPercentages()
                };

                this.presetAges = [
                    '3 months old', '6 months old', '1 year old', '2 years old',
                    '3 years old', '4 years old', '5 years old'
                ];

                this.facialFeatures = [
                    { key: 'forehead', label: '이마', color: '#ff6961' },
                    { key: 'eyebrows', label: '눈썹', color: '#ffb480' },
                    { key: 'glabella', label: '미간', color: '#f8f38d' },
                    { key: 'eyes', label: '눈', color: '#42d6a4' },
                    { key: 'underEyes', label: '애교살', color: '#08cad1' },
                    { key: 'temples', label: '관자놀이', color: '#59adf6' },
                    { key: 'nose', label: '코', color: '#9d94ff' },
                    { key: 'nasolabialArea', label: '코 옆', color: '#c780e8' },
                    { key: 'cheeks', label: '뺨', color: '#ff92c2' },
                    { key: 'cheekbones', label: '광대뼈', color: '#a2d2ff' },
                    { key: 'mouth', label: '입', color: '#ffb3de' },
                    { key: 'jawline', label: '턱선/턱', color: '#ffdfb8' },
                    { key: 'ears', label: '귀', color: '#b0e0e6' }
                ];

                this.isLoading = false;
                this.currentHighlightedFeature = null;

                this.init();
            }

            // ===== 보안 API 관리 =====
            async getSecureApiKey() {
                // 이미 로드된 키가 있으면 재사용 (캐싱)
                if (this._cachedApiKey !== undefined) {
                    console.log('✅ 캐시된 API 키 사용');
                    return this._cachedApiKey;
                }

                // 다양한 소스에서 API 키 시도 (보안 순서대로)
                let apiKey = null;

                // 1. 환경변수에서 시도 (Node.js 환경)
                if (typeof process !== 'undefined' && process.env && process.env.GEMINI_API_KEY) {
                    apiKey = process.env.GEMINI_API_KEY;
                    console.log('✅ 환경변수에서 API 키 로드됨');
                }

                // 2. 서버 엔드포인트에서 키 가져오기 시도
                if (!apiKey) {
                    try {
                        const response = await fetch('/api/get-key', {
                            method: 'GET',
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            apiKey = data.apiKey;
                            console.log('✅ 서버에서 API 키 로드됨');
                        }
                    } catch (error) {
                        console.log('ℹ️ 서버 엔드포인트 없음, 로컬 모드로 진행');
                    }
                }

                // 3. 로컬/개발 환경용 관리자 설정 키 (사용량 제한 적용됨)
                if (!apiKey && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                    console.log('✅ 개발 환경 감지: 사용량 제한이 적용된 관리자 키 사용');

                    // 사용량 제한이 설정된 키 부분들
                    const encodedParts = [
                        'QUl6YVN5Q3RCb1U=',  // AIzaSyCtBoU
                        'LTM0a3FkZU5UVEttQ1ljc0ZmRjdR',  // -34kqdeNTTKmCYcsFfF7Q
                        'SWVRYUFBZw==',  // IeQaAAg
                    ];

                    try {
                        const keyParts = encodedParts.map(part => atob(part));
                        apiKey = keyParts.join('');
                        console.log('✅ API 키 로드 완료 (사용량 제한 적용)');
                    } catch (error) {
                        console.error('키 디코딩 실패:', error);
                    }
                }

                if (!apiKey) {
                    console.error('❌ API 키를 찾을 수 없습니다. 관리자에게 문의하세요.');
                    this.updateServiceStatus('offline');
                    this._cachedApiKey = null;
                    return null;
                }

                // 캐시에 저장
                this._cachedApiKey = apiKey;

                // API 키 연결 테스트 실행
                this.testApiConnectivity(apiKey);

                return apiKey;
            }

            async testApiConnectivity(apiKey) {
                if (!apiKey) {
                    console.error('API 키가 없어 연결 테스트를 수행할 수 없습니다.');
                    this.updateServiceStatus('offline');
                    return;
                }

                try {
                    // 간단한 AI API 연결 테스트
                    const testUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;

                    const response = await fetch(testUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        this.updateServiceStatus('online');
                    } else {
                        throw new Error(`API 연결 실패: ${response.status}`);
                    }
                } catch (error) {
                    console.error('API 연결 테스트 실패:', error);
                    this.updateServiceStatus('offline');
                }
            }

            updateServiceStatus(status) {
                const statusElement = document.getElementById('service-status');
                const statusText = document.getElementById('service-status-text');

                if (status === 'online') {
                    statusElement.style.backgroundColor = '#10b981'; // 녹색
                    statusElement.style.color = 'white';
                    statusText.textContent = 'Service On';
                    this.serviceStatus = 'online';
                } else {
                    statusElement.style.backgroundColor = '#ef4444'; // 빨간색
                    statusElement.style.color = 'white';
                    statusText.textContent = 'Service Off';
                    this.serviceStatus = 'offline';
                }
            }

            async init() {
                this.setupEventListeners();

                // API 키 비동기 로드
                this.apiKey = await this.getSecureApiKey();

                this.checkApiKey();
                await this.initializeAuth();
                this.createPresetAgeButtons();
                this.createDetailedSliders();
                this.updateUI();
                this.handlePaymentResult();
            }

            initializeDetailedPercentages() {
                const percentages = {};
                this.facialFeatures?.forEach(feature => {
                    percentages[feature.key] = { mom: 50, dad: 50 };
                }) || {};
                return percentages;
            }

            // ===== AUTHENTICATION METHODS =====
            async initializeAuth() {
                try {
                    // 현재 세션 확인
                    const { data: { session } } = await this.supabase.auth.getSession();
                    if (session) {
                        this.currentUser = session.user;
                        this.isAuthenticated = true;
                        await this.loadUserProfile();
                        await this.loadCartItems();
                    }

                    // 인증 상태 변경 리스너
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        console.log('Auth state changed:', event);
                        if (session) {
                            this.currentUser = session.user;
                            this.isAuthenticated = true;
                            this.loadUserProfile();
                            this.loadCartItems();
                        } else {
                            this.currentUser = null;
                            this.isAuthenticated = false;
                            this.cartItems = [];
                        }
                        this.updateAuthUI();
                    });

                    this.updateAuthUI();
                } catch (error) {
                    console.error('Auth initialization error:', error);
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;

                try {
                    const { data: profile } = await this.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();

                    if (!profile) {
                        // 프로필이 없으면 생성
                        await this.createUserProfile();
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                }
            }

            async createUserProfile() {
                if (!this.currentUser) return;

                try {
                    const { error } = await this.supabase
                        .from('profiles')
                        .insert({
                            id: this.currentUser.id,
                            email: this.currentUser.email,
                            full_name: this.currentUser.user_metadata?.full_name || this.currentUser.email?.split('@')[0] || 'User',
                            avatar_url: this.currentUser.user_metadata?.avatar_url
                        });

                    if (error) throw error;
                } catch (error) {
                    console.error('Error creating profile:', error);
                }
            }

            updateAuthUI() {
                const authButtons = document.getElementById('auth-buttons');
                const userMenu = document.getElementById('user-menu');
                const userInfo = document.getElementById('user-info');
                const cartFloating = document.getElementById('cart-floating');

                if (this.isAuthenticated && this.currentUser) {
                    // 로그인 상태
                    authButtons.style.display = 'none';
                    userMenu.style.display = 'flex';
                    userInfo.style.display = 'flex';
                    cartFloating.style.display = 'block';

                    // 사용자 정보 업데이트
                    const userName = this.currentUser.user_metadata?.full_name ||
                                   this.currentUser.email?.split('@')[0] || 'User';
                    document.getElementById('user-name').textContent = userName;
                    document.getElementById('user-email').textContent = this.currentUser.email;
                    document.getElementById('user-avatar').textContent = userName.charAt(0).toUpperCase();

                    this.updateCartUI();
                } else {
                    // 로그아웃 상태
                    authButtons.style.display = 'flex';
                    userMenu.style.display = 'none';
                    userInfo.style.display = 'none';
                    cartFloating.style.display = 'none';
                }
            }

            // 로그인 모달 표시/숨김
            showLoginModal() {
                document.getElementById('login-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            hideLoginModal() {
                document.getElementById('login-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            // 회원가입 모달 표시/숨김
            showSignupModal() {
                document.getElementById('signup-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            hideSignupModal() {
                document.getElementById('signup-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            // 모달 전환
            switchToSignup() {
                this.hideLoginModal();
                this.showSignupModal();
            }

            switchToLogin() {
                this.hideSignupModal();
                this.showLoginModal();
            }

            // 이메일/비밀번호 로그인
            async handleLogin(e) {
                e.preventDefault();
                console.log('🔄 로그인 시도 시작');

                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                console.log('📧 로그인 정보:', {
                    email: email ? '***@' + email.split('@')[1] : '없음',
                    hasPassword: !!password
                });

                // 이전 오류 메시지 숨기기
                this.hideLoginError();

                // 로그인 버튼 비활성화
                const loginBtn = document.getElementById('login-submit-btn');
                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>로그인 중...';
                }

                if (!email || !password) {
                    this.showLoginError('이메일과 비밀번호를 입력해주세요.');
                    this.resetLoginButton(loginBtn);
                    return;
                }

                try {
                    console.log('🔑 Supabase 로그인 요청 중...');
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    console.log('📨 로그인 응답:', { data, error });

                    if (error) {
                        console.error('❌ 로그인 오류:', error);
                        // Supabase Auth 에러 메시지 처리
                        if (error.message.includes('Invalid login credentials')) {
                            this.showLoginError('이메일 또는 비밀번호가 올바르지 않습니다.');
                        } else if (error.message.includes('Email not confirmed')) {
                            this.showLoginError('이메일 인증이 필요합니다. 이메일을 확인해주세요.');
                        } else if (error.message.includes('Invalid email')) {
                            this.showLoginError('올바른 이메일 주소를 입력해주세요.');
                        } else {
                            this.showLoginError(error.message || '로그인에 실패했습니다.');
                        }
                        this.resetLoginButton(loginBtn);
                        return;
                    }

                    console.log('✅ 로그인 성공:', data);
                    this.hideLoginModal();
                    this.showSuccess('로그인되었습니다!');
                    this.resetLoginButton(loginBtn);

                } catch (error) {
                    console.error('💥 로그인 예외:', error);
                    this.showLoginError(error.message || '로그인에 실패했습니다.');
                    this.resetLoginButton(loginBtn);
                }
            }

            // 로그인 버튼 상태 복원
            resetLoginButton(loginBtn) {
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>로그인';
                }
            }

            // 이메일/비밀번호 회원가입
            async handleSignup(e) {
                e.preventDefault();
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-password-confirm').value;

                if (!name || !email || !password) {
                    this.showError('모든 필드를 입력해주세요.');
                    return;
                }

                if (password.length < 6) {
                    this.showError('비밀번호는 최소 6자 이상이어야 합니다.');
                    return;
                }

                if (password !== confirmPassword) {
                    this.showError('비밀번호가 일치하지 않습니다.');
                    return;
                }

                try {
                    // 1. 먼저 이메일 중복 확인
                    console.log('📧 이메일 중복 확인 중:', email);

                    const { data: existingUsers, error: checkError } = await this.supabase
                        .from('profiles')
                        .select('email')
                        .eq('email', email)
                        .limit(1);

                    if (checkError) {
                        console.log('⚠️ 프로필 테이블에서 확인 실패, auth 테이블 확인');
                        // profiles 테이블이 없거나 오류 시 auth 테이블에서 확인 시도는 불가하므로 계속 진행
                    } else if (existingUsers && existingUsers.length > 0) {
                        this.showError('이미 가입된 이메일입니다. 로그인을 시도해주세요.');
                        return;
                    }

                    // 2. 개발자 모드 확인
                    const skipEmailVerification = document.getElementById('skip-email-verification')?.checked || false;
                    console.log('🔧 개발자 모드:', { skipEmailVerification });

                    // 3. 중복이 없으면 회원가입 진행
                    console.log('✅ 이메일 중복 없음, 회원가입 진행');
                    console.log('🔄 회원가입 요청:', {
                        email,
                        skipEmailVerification,
                        redirect: `${window.location.origin}?confirmed=true`
                    });

                    let signUpOptions = {
                        data: {
                            full_name: name
                        }
                    };

                    // 개발자 모드가 아닌 경우에만 이메일 리다이렉트 URL 추가
                    if (!skipEmailVerification) {
                        signUpOptions.emailRedirectTo = `${window.location.origin}?confirmed=true`;
                    }

                    const { data, error } = await this.supabase.auth.signUp({
                        email,
                        password,
                        options: signUpOptions
                    });

                    console.log('📨 회원가입 응답:', { data, error });

                    if (error) {
                        console.error('❌ 회원가입 오류:', error);
                        // Supabase Auth 에러 메시지 처리
                        if (error.message.includes('User already registered')) {
                            this.showError('이미 가입된 이메일입니다. 로그인을 시도해주세요.');
                        } else if (error.message.includes('Invalid email')) {
                            this.showError('올바른 이메일 주소를 입력해주세요.');
                        } else if (error.message.includes('Password should be at least')) {
                            this.showError('비밀번호는 최소 6자 이상이어야 합니다.');
                        } else if (error.message.includes('Signups not allowed')) {
                            this.showError('현재 회원가입이 비활성화되어 있습니다. 관리자에게 문의하세요.');
                        } else if (error.message.includes('Email rate limit exceeded')) {
                            this.showError('이메일 전송 한도를 초과했습니다. 잠시 후 다시 시도해주세요.');
                        } else {
                            this.showError(`회원가입에 실패했습니다: ${error.message}`);
                        }
                        return;
                    }

                    console.log('✅ 회원가입 성공:', data);
                    this.hideSignupModal();

                    // 이메일 확인이 필요한 경우와 바로 로그인되는 경우 구분
                    console.log('👤 사용자 정보:', {
                        user: data.user,
                        session: data.session,
                        email_confirmed_at: data.user?.email_confirmed_at,
                        confirmation_sent_at: data.user?.confirmation_sent_at
                    });

                    // Supabase 이메일 확인 설정 감지
                    const hasSession = data.session && data.session.access_token;
                    const needsEmailConfirmation = data.user && !data.user.email_confirmed_at && !hasSession && !skipEmailVerification;

                    if (skipEmailVerification) {
                        console.log('🔧 개발자 모드: 이메일 확인 건너뛰기');
                        this.showSuccess('개발자 모드로 회원가입이 완료되었습니다!\n\n이메일 확인 없이 바로 로그인할 수 있습니다.');
                    } else if (needsEmailConfirmation) {
                        console.log('📧 이메일 확인 필요 - Supabase에서 "Enable email confirmations"이 활성화되어 있습니다.');

                        // 이메일 전송 확인
                        if (data.user.confirmation_sent_at) {
                            console.log('✅ 확인 이메일 전송됨:', data.user.confirmation_sent_at);
                            this.showSuccess(`회원가입이 완료되었습니다!\n\n📧 ${email}로 확인 이메일을 전송했습니다.\n이메일의 링크를 클릭하여 계정을 활성화해주세요.\n\n⚠️ 이메일이 오지 않는다면:\n• 스팸함을 확인해주세요\n• 잠시 후 재전송 옵션을 이용해주세요`);

                            // 이메일 재전송 옵션 제공
                            setTimeout(() => {
                                if (confirm('확인 이메일이 도착하지 않으셨나요?\n\n이메일을 다시 전송하시겠습니까?')) {
                                    this.resendConfirmationEmail(email);
                                }
                            }, 15000); // 15초 후 재전송 옵션 제공
                        } else {
                            console.warn('⚠️ 확인 이메일이 전송되지 않았을 수 있습니다.');
                            this.showError('회원가입은 완료되었지만 확인 이메일 전송에 문제가 발생했습니다.\n\n아래 버튼을 클릭하여 이메일을 재전송해주세요.');

                            // 즉시 재전송 옵션 제공
                            setTimeout(() => {
                                this.resendConfirmationEmail(email);
                            }, 2000);
                        }
                    } else if (hasSession) {
                        this.showSuccess('회원가입이 완료되어 자동으로 로그인되었습니다!');
                        console.log('✅ 이메일 확인 없이 바로 로그인됨 - Supabase 설정에서 "Enable email confirmations"이 비활성화되어 있습니다.');
                    } else if (data.user && data.user.email_confirmed_at) {
                        this.showSuccess('회원가입이 완료되었습니다! 이메일이 이미 확인되어 바로 로그인할 수 있습니다.');
                        console.log('✅ 이메일이 이미 확인된 상태입니다.');
                    } else {
                        this.showSuccess('회원가입이 완료되었습니다! 로그인해주세요.');
                        console.log('⚠️ 예상치 못한 상태:', {
                            user: data.user,
                            session: data.session,
                            email_confirmed_at: data.user?.email_confirmed_at
                        });
                    }

                } catch (error) {
                    console.error('Signup error:', error);
                    if (error.message.includes('already')) {
                        this.showError('이미 가입된 이메일입니다. 로그인을 시도해주세요.');
                    } else {
                        this.showError(error.message || '회원가입에 실패했습니다.');
                    }
                }
            }

            // Google 로그인
            async loginWithGoogle() {
                try {
                    const { data, error } = await this.supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.origin
                        }
                    });

                    if (error) throw error;
                } catch (error) {
                    console.error('Google login error:', error);
                    this.showError('Google 로그인에 실패했습니다.');
                }
            }

            // 로그아웃
            async logout() {
                try {
                    const { error } = await this.supabase.auth.signOut();
                    if (error) throw error;

                    this.showSuccess('로그아웃되었습니다.');
                } catch (error) {
                    console.error('Logout error:', error);
                    this.showError('로그아웃에 실패했습니다.');
                }
            }

            // ===== CART & PURCHASE METHODS =====
            async loadCartItems() {
                if (!this.isAuthenticated) return;

                try {
                    // 개발 모드 사용자인 경우 로컬 스토리지 사용
                    if (this.currentUser && this.currentUser.isDevelopmentUser) {
                        console.log('🔧 개발 모드 - 로컬 장바구니 로드');
                        const localCart = JSON.parse(localStorage.getItem('dev_cart_items') || '[]');
                        this.cartItems = localCart;
                        this.updateCartUI();
                        console.log('✅ 개발 모드 장바구니 로드 완료:', this.cartItems);
                        return;
                    }

                    const { data: cartItems, error } = await this.supabase
                        .from('cart_items')
                        .select(`
                            *,
                            generated_images (
                                id,
                                image_url,
                                thumbnail_url,
                                image_type,
                                generation_settings,
                                price_cents
                            )
                        `)
                        .eq('user_id', this.currentUser.id);

                    if (error) throw error;

                    this.cartItems = cartItems || [];
                    this.updateCartUI();
                } catch (error) {
                    console.error('Error loading cart items:', error);
                }
            }

            updateCartUI() {
                const cartCount = this.cartItems.length;
                const cartTotal = this.cartItems.reduce((sum, item) =>
                    sum + (item.price_cents * item.quantity), 0);

                // 헤더 장바구니 카운트 업데이트
                document.getElementById('cart-count').textContent = cartCount;

                // 플로팅 버튼 배지 업데이트
                const floatingBadge = document.getElementById('cart-floating-badge');
                if (cartCount > 0) {
                    floatingBadge.textContent = cartCount;
                    floatingBadge.style.display = 'block';
                } else {
                    floatingBadge.style.display = 'none';
                }

                // 장바구니 총액 업데이트
                document.getElementById('cart-total').textContent = this.formatPrice(cartTotal);

                // 결제 버튼 활성화/비활성화
                document.getElementById('checkout-btn').disabled = cartCount === 0;
            }

            async addToCart(imageId, imageData) {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    // 이미지를 데이터베이스에 저장
                    const { data: savedImage, error: saveError } = await this.supabase
                        .from('generated_images')
                        .insert({
                            user_id: this.currentUser.id,
                            image_url: imageData.src,
                            image_type: this.inputMode,
                            generation_settings: {
                                ...this.settings,
                                age: imageData.age,
                                inputMode: this.inputMode
                            },
                            price_cents: this.pricing[this.inputMode]
                        })
                        .select()
                        .single();

                    if (saveError) throw saveError;

                    // 장바구니에 추가
                    const { error: cartError } = await this.supabase
                        .from('cart_items')
                        .insert({
                            user_id: this.currentUser.id,
                            image_id: savedImage.id,
                            quantity: 1,
                            price_cents: this.pricing[this.inputMode]
                        });

                    if (cartError) throw cartError;

                    await this.loadCartItems();
                    this.showSuccess('장바구니에 추가되었습니다!');
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    this.showError('장바구니 추가에 실패했습니다.');
                }
            }

            async removeFromCart(cartItemId) {
                try {
                    const { error } = await this.supabase
                        .from('cart_items')
                        .delete()
                        .eq('id', cartItemId);

                    if (error) throw error;

                    await this.loadCartItems();
                    this.renderCartItems();
                } catch (error) {
                    console.error('Error removing from cart:', error);
                    this.showError('장바구니에서 제거하는데 실패했습니다.');
                }
            }

            async buyNow(imageId, imageData) {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    // 이미지를 데이터베이스에 저장
                    const { data: savedImage, error: saveError } = await this.supabase
                        .from('generated_images')
                        .insert({
                            user_id: this.currentUser.id,
                            image_url: imageData.src,
                            image_type: this.inputMode,
                            generation_settings: {
                                ...this.settings,
                                age: imageData.age,
                                inputMode: this.inputMode
                            },
                            price_cents: this.pricing[this.inputMode]
                        })
                        .select()
                        .single();

                    if (saveError) throw saveError;

                    // 즉시 주문 생성
                    await this.createOrderFromItems([{
                        image_id: savedImage.id,
                        quantity: 1,
                        price_cents: this.pricing[this.inputMode]
                    }]);
                } catch (error) {
                    console.error('Error in buy now:', error);
                    this.showError('구매에 실패했습니다.');
                }
            }

            async createOrderFromItems(items) {
                try {
                    const totalAmount = items.reduce((sum, item) =>
                        sum + (item.price_cents * item.quantity), 0);

                    // 주문 번호 생성
                    const orderNumber = `MYB-${new Date().toISOString().slice(0, 10).replace(/-/g, '')}-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;

                    // 주문 생성
                    const { data: order, error: orderError } = await this.supabase
                        .from('orders')
                        .insert({
                            user_id: this.currentUser.id,
                            order_number: orderNumber,
                            total_amount_cents: totalAmount,
                            status: 'pending'
                        })
                        .select()
                        .single();

                    if (orderError) throw orderError;

                    // 주문 항목 추가
                    const { error: itemsError } = await this.supabase
                        .from('order_items')
                        .insert(items.map(item => ({
                            order_id: order.id,
                            image_id: item.image_id,
                            quantity: item.quantity,
                            unit_price_cents: item.price_cents,
                            total_price_cents: item.price_cents * item.quantity
                        })));

                    if (itemsError) throw itemsError;

                    // Polar Payment로 리다이렉트
                    await this.initiatePolarPayment(order.id, totalAmount);
                } catch (error) {
                    console.error('Error creating order:', error);
                    this.showError('주문 생성에 실패했습니다: ' + error.message);
                }
            }

            // 장바구니 모달 표시/숨김
            showCartModal() {
                document.getElementById('cart-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                this.renderCartItems();
            }

            hideCartModal() {
                document.getElementById('cart-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            renderCartItems() {
                console.log('🛒 renderCartItems 호출됨, cartItems:', this.cartItems);
                const container = document.getElementById('cart-items');
                container.innerHTML = '';

                if (this.cartItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>장바구니가 비어있습니다</p>
                        </div>
                    `;
                    return;
                }

                this.cartItems.forEach((item, index) => {
                    console.log(`🛒 처리 중인 item ${index}:`, item);
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'display: flex; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--color-border);';

                    // item_data에서 데이터 가져오기
                    const itemData = item.item_data || {};
                    const imageType = itemData.type || 'separate';
                    const settings = itemData.settings || {};

                    itemDiv.innerHTML = `
                        <div style="width: 60px; height: 60px; background: var(--color-border); border-radius: 0.5rem;
                                    display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary);">
                            <i class="fas fa-baby" style="font-size: 1.5rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                ${this.getImageTypeLabel(imageType)} 이미지
                            </div>
                            <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                수량: ${item.quantity}개, ${settings.selectedAges?.join(', ') || '3개월'}
                            </div>
                            <div style="font-weight: 600; color: var(--color-secondary);">
                                ${this.formatPrice(item.price_cents)}
                            </div>
                        </div>
                        <button onclick="app.removeFromCart('${item.id}')"
                                style="background: #ef4444; color: white; border: none; border-radius: 0.25rem;
                                       padding: 0.5rem; cursor: pointer; height: fit-content;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;

                    container.appendChild(itemDiv);
                });
            }

            updateCartDisplay() {
                // 장바구니 배지 업데이트
                const cartBadge = document.getElementById('cart-badge');
                const cartFloatingBadge = document.getElementById('cart-floating-badge');
                const cartCount = this.cartItems.length;

                if (cartCount > 0) {
                    if (cartBadge) {
                        cartBadge.textContent = cartCount;
                        cartBadge.style.display = 'block';
                    }
                    if (cartFloatingBadge) {
                        cartFloatingBadge.textContent = cartCount;
                        cartFloatingBadge.style.display = 'block';
                    }

                    // 플로팅 장바구니 버튼 표시
                    const cartFloating = document.getElementById('cart-floating');
                    if (cartFloating) {
                        cartFloating.style.display = 'block';
                    }
                } else {
                    if (cartBadge) cartBadge.style.display = 'none';
                    if (cartFloatingBadge) cartFloatingBadge.style.display = 'none';

                    // 플로팅 장바구니 버튼 숨김
                    const cartFloating = document.getElementById('cart-floating');
                    if (cartFloating) {
                        cartFloating.style.display = 'none';
                    }
                }

                // 장바구니 모달이 열려있다면 아이템 다시 렌더링
                const cartModal = document.getElementById('cart-modal');
                if (cartModal && cartModal.style.display === 'flex') {
                    this.renderCartItems();
                }
            }

            async checkout() {
                if (this.cartItems.length === 0) return;

                try {
                    await this.createOrderFromItems(this.cartItems.map(item => ({
                        image_id: item.image_id,
                        quantity: item.quantity,
                        price_cents: item.price_cents
                    })));
                } catch (error) {
                    console.error('Checkout error:', error);
                    this.showError('결제에 실패했습니다.');
                }
            }

            async initiatePolarPayment(orderId, totalAmount) {
                try {
                    if (!this.polar) {
                        // Fallback: Direct API 호출
                        return await this.createPolarCheckoutDirect(orderId, totalAmount);
                    }

                    // Polar SDK를 사용한 결제 생성
                    const checkoutData = {
                        payment_processor: 'stripe',
                        success_url: `${window.location.origin}?payment=success&order=${orderId}`,
                        cancel_url: `${window.location.origin}?payment=cancel&order=${orderId}`,
                        customer_billing_address: {
                            line1: '',
                            country: 'KR'
                        },
                        metadata: {
                            order_id: orderId,
                            user_id: this.currentUser.id
                        }
                    };

                    const checkout = await this.polarCheckoutApi.checkoutsCreate(checkoutData);

                    // Supabase에 결제 정보 업데이트
                    await this.supabase
                        .from('orders')
                        .update({
                            payment_id: checkout.id,
                            payment_url: checkout.url,
                            status: 'processing'
                        })
                        .eq('id', orderId);

                    // 결제 페이지로 리다이렉트
                    window.location.href = checkout.url;

                } catch (error) {
                    console.error('Polar payment error:', error);
                    this.showError('결제 처리 중 오류가 발생했습니다: ' + error.message);
                }
            }

            async createPolarCheckoutDirect(orderId, totalAmount) {
                try {
                    // Direct API 호출을 통한 Polar 결제 생성
                    const response = await fetch('https://api.polar.sh/v1/checkouts/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.polarAccessToken}`
                        },
                        body: JSON.stringify({
                            payment_processor: 'stripe',
                            success_url: `${window.location.origin}?payment=success&order=${orderId}`,
                            cancel_url: `${window.location.origin}?payment=cancel&order=${orderId}`,
                            customer_billing_address: {
                                line1: '',
                                country: 'KR'
                            },
                            metadata: {
                                order_id: orderId,
                                user_id: this.currentUser.id,
                                total_amount_cents: totalAmount
                            },
                            amount: totalAmount,
                            currency: 'USD'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Polar API Error: ${response.status}`);
                    }

                    const checkout = await response.json();

                    // Supabase에 결제 정보 업데이트
                    await this.supabase
                        .from('orders')
                        .update({
                            payment_id: checkout.id,
                            payment_url: checkout.url,
                            status: 'processing'
                        })
                        .eq('id', orderId);

                    // 결제 페이지로 리다이렉트
                    window.location.href = checkout.url;

                } catch (error) {
                    console.error('Direct Polar API error:', error);
                    this.showError('결제 시스템 연결에 실패했습니다: ' + error.message);
                }
            }

            // 결제 결과 처리
            handlePaymentResult() {
                const urlParams = new URLSearchParams(window.location.search);
                const paymentStatus = urlParams.get('payment');
                const orderId = urlParams.get('order');
                const paymentType = urlParams.get('type'); // 'direct' 또는 없음 (장바구니)

                if (paymentStatus && orderId) {
                    if (paymentStatus === 'success') {
                        this.handlePaymentSuccess(orderId, paymentType);
                    } else if (paymentStatus === 'cancel') {
                        this.handlePaymentCancel(orderId);
                    }
                }
            }

            async handlePaymentSuccess(orderId, paymentType) {
                try {
                    console.log('💳 결제 완료 확인됨, 주문 ID:', orderId, '결제 타입:', paymentType);

                    // 주문 상태를 완료로 업데이트
                    await this.supabase
                        .from('orders')
                        .update({
                            status: 'completed',
                            payment_completed_at: new Date().toISOString()
                        })
                        .eq('id', orderId);

                    if (paymentType === 'direct') {
                        // 즉시 결제 타입: sessionStorage에서 설정 복원
                        console.log('🔄 즉시 결제 - 설정 복원 중...');

                        const pendingData = sessionStorage.getItem('pendingGeneration');
                        if (pendingData) {
                            const { settings } = JSON.parse(pendingData);

                            try {
                                // 생성 설정 복원
                                this.restoreGenerationSettings(settings);

                                // 실제 이미지 생성 API 호출
                                const generatedImages = await this.generateImagesOnly();

                                console.log('✅ 즉시 결제 - 이미지 생성 완료:', generatedImages);

                                // 생성된 이미지를 처리 대기열에 추가
                                await this.supabase
                                    .rpc('add_to_processing_queue', {
                                        user_uuid: this.currentUser.id,
                                        order_uuid: orderId,
                                        gen_type: settings.inputMode,
                                        gen_params: {
                                            settings: settings,
                                            generated_images: generatedImages,
                                            generated_at: new Date().toISOString()
                                        },
                                        priority_level: 1 // 즉시 결제는 높은 우선순위
                                    });

                                // 임시 저장 데이터 삭제
                                sessionStorage.removeItem('pendingGeneration');

                            } catch (imageGenError) {
                                console.error('즉시 결제 - 이미지 생성 오류:', imageGenError);

                                // 이미지 생성 실패 시에도 대기열에 오류 상태로 추가
                                await this.supabase
                                    .rpc('add_to_processing_queue', {
                                        user_uuid: this.currentUser.id,
                                        order_uuid: orderId,
                                        gen_type: settings.inputMode,
                                        gen_params: {
                                            settings: settings,
                                            error: imageGenError.message,
                                            failed_at: new Date().toISOString()
                                        },
                                        priority_level: 1
                                    });
                            }
                        }

                    } else {
                        // 장바구니 결제 타입: 장바구니에서 항목 가져오기
                        console.log('🛒 장바구니 결제 - 항목 처리 중...');

                        // 주문에 연결된 장바구니 항목 정보 가져오기
                        const { data: cartItems, error: cartError } = await this.supabase
                            .from('cart_items')
                            .select('*')
                            .eq('user_id', this.currentUser.id);

                        if (cartError) throw cartError;

                        console.log('🛒 결제 완료된 장바구니 항목들:', cartItems);

                        // 각 장바구니 항목에 대해 이미지 생성 API 호출
                        for (const cartItem of cartItems) {
                            try {
                                console.log('🎨 이미지 생성 시작:', cartItem);

                                // 장바구니 항목의 설정을 기반으로 이미지 생성
                                const itemData = cartItem.item_data;

                                // 생성 설정 복원
                                this.restoreGenerationSettings(itemData.settings);

                                // 실제 이미지 생성 API 호출
                                const generatedImages = await this.generateImagesOnly();

                                console.log('✅ 이미지 생성 완료:', generatedImages);

                                // 생성된 이미지를 처리 대기열에 추가
                                await this.supabase
                                    .rpc('add_to_processing_queue', {
                                        user_uuid: this.currentUser.id,
                                        order_uuid: orderId,
                                        gen_type: itemData.type,
                                        gen_params: {
                                            settings: itemData.settings,
                                            generated_images: generatedImages,
                                            generated_at: new Date().toISOString()
                                        },
                                        priority_level: 0
                                    });

                                console.log('📋 처리 대기열에 추가 완료');

                            } catch (imageGenError) {
                                console.error('이미지 생성 오류:', imageGenError);

                                // 이미지 생성 실패 시에도 대기열에 오류 상태로 추가
                                await this.supabase
                                    .rpc('add_to_processing_queue', {
                                        user_uuid: this.currentUser.id,
                                        order_uuid: orderId,
                                        gen_type: cartItem.item_data.type,
                                        gen_params: {
                                            settings: cartItem.item_data.settings,
                                            error: imageGenError.message,
                                            failed_at: new Date().toISOString()
                                        },
                                        priority_level: 0
                                    });
                            }
                        }

                        // 장바구니 비우기
                        await this.supabase
                            .from('cart_items')
                            .delete()
                            .eq('user_id', this.currentUser.id);
                    }

                    this.showSuccess('결제가 완료되고 이미지 생성이 시작되었습니다! 처리 현황에서 진행상황을 확인할 수 있습니다.');
                    this.loadCartItems();

                    // 처리 현황 모달 표시
                    this.showProcessingQueueModal();

                    // URL 파라미터 정리
                    window.history.replaceState(null, '', window.location.pathname);

                } catch (error) {
                    console.error('Payment success handling error:', error);
                    this.showError('결제 완료 처리 중 오류가 발생했습니다: ' + error.message);
                }
            }

            async handlePaymentCancel(orderId) {
                try {
                    // 주문 상태를 취소로 업데이트
                    await this.supabase
                        .from('orders')
                        .update({ status: 'failed' })
                        .eq('id', orderId);

                    this.showError('결제가 취소되었습니다.');

                    // URL 파라미터 정리
                    window.history.replaceState(null, '', window.location.pathname);
                } catch (error) {
                    console.error('Payment cancel handling error:', error);
                }
            }

            // 유틸리티 메서드들
            formatPrice(cents) {
                return `$${(cents / 100).toFixed(2)}`;
            }

            getImageTypeLabel(type) {
                const labels = {
                    ultrasound: '초음파',
                    separate: '부모 개별',
                    together: '부모 함께'
                };
                return labels[type] || type;
            }

            showSuccess(message) {
                // 간단한 성공 메시지 표시
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; top: 2rem; right: 2rem; z-index: 1000;
                    background: var(--color-secondary); color: white;
                    padding: 1rem 1.5rem; border-radius: 0.5rem;
                    box-shadow: var(--shadow-lg);
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // 주문 이력 모달 표시/숨김
            showOrdersModal() {
                document.getElementById('orders-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                this.loadOrderHistory();
            }

            hideOrdersModal() {
                document.getElementById('orders-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            async loadOrderHistory() {
                if (!this.isAuthenticated) return;

                try {
                    const { data: orders, error } = await this.supabase
                        .from('orders')
                        .select(`
                            *,
                            order_items (
                                *,
                                generated_images (*)
                            )
                        `)
                        .eq('user_id', this.currentUser.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.renderOrderHistory(orders);
                } catch (error) {
                    console.error('주문 이력 로딩 오류:', error);
                    this.showError('주문 이력을 불러올 수 없습니다.');
                }
            }

            renderOrderHistory(orders) {
                const container = document.getElementById('orders-list');
                container.innerHTML = '';

                if (!orders || orders.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">
                            <i class="fas fa-receipt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>주문 이력이 없습니다</p>
                        </div>
                    `;
                    return;
                }

                orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.style.cssText = 'border-bottom: 1px solid var(--color-border); padding: 1.5rem 0;';

                    const orderDate = new Date(order.created_at).toLocaleDateString('ko-KR');
                    const statusClass = this.getOrderStatusClass(order.status);
                    const statusText = this.getOrderStatusText(order.status);

                    orderDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    주문번호: ${order.order_number}
                                </div>
                                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                    주문일: ${orderDate}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                총 금액: ${this.formatPrice(order.total_amount_cents)}
                            </div>
                        </div>
                        <div class="order-items" style="display: grid; gap: 0.75rem;">
                            ${order.order_items.map(item => this.renderOrderItem(item, order.status)).join('')}
                        </div>
                    `;

                    container.appendChild(orderDiv);
                });
            }

            renderOrderItem(orderItem, orderStatus) {
                const image = orderItem.generated_images;
                const downloadBtn = orderStatus === 'completed' ?
                    `<button onclick="app.downloadPurchasedImage('${image.id}', '${image.image_url}')"
                             style="background: var(--color-secondary); color: white; border: none;
                                    border-radius: 0.25rem; padding: 0.5rem 1rem; cursor: pointer;
                                    font-size: 0.875rem;">
                        <i class="fas fa-download" style="margin-right: 0.25rem;"></i>다운로드
                     </button>` : '';

                return `
                    <div style="display: flex; gap: 1rem; align-items: center; padding: 0.75rem;
                                background: var(--color-background-secondary); border-radius: 0.5rem;">
                        <img src="${image.thumbnail_url || image.image_url}"
                             alt="구매한 이미지"
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.5rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                ${this.getImageTypeLabel(image.image_type)} 이미지
                            </div>
                            <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                수량: ${orderItem.quantity}
                            </div>
                            <div style="font-weight: 600; color: var(--color-secondary);">
                                ${this.formatPrice(orderItem.total_price_cents)}
                            </div>
                        </div>
                        ${downloadBtn}
                    </div>
                `;
            }

            getOrderStatusClass(status) {
                const classes = {
                    pending: 'status-pending',
                    processing: 'status-processing',
                    completed: 'status-completed',
                    failed: 'status-failed',
                    refunded: 'status-refunded'
                };
                return classes[status] || 'status-pending';
            }

            getOrderStatusText(status) {
                const texts = {
                    pending: '결제 대기',
                    processing: '처리 중',
                    completed: '완료',
                    failed: '실패',
                    refunded: '환불'
                };
                return texts[status] || status;
            }

            async downloadPurchasedImage(imageId, imageUrl) {
                try {
                    // 다운로드 이력 기록
                    await this.supabase
                        .from('download_history')
                        .insert({
                            user_id: this.currentUser.id,
                            image_id: imageId,
                            download_count: 1
                        });

                    // 이미지 다운로드
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `purchased-image-${imageId}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    window.URL.revokeObjectURL(url);

                    this.showSuccess('이미지가 다운로드되었습니다!');
                } catch (error) {
                    console.error('이미지 다운로드 오류:', error);
                    this.showError('이미지 다운로드에 실패했습니다.');
                }
            }

            // Processing Queue Modal Functions
            showQueueModal() {
                document.getElementById('queue-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                this.loadProcessingQueue();
            }

            hideQueueModal() {
                document.getElementById('queue-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            async loadProcessingQueue() {
                if (!this.isAuthenticated) return;

                try {
                    const { data: queueItems, error } = await this.supabase
                        .rpc('get_user_queue_status', { user_uuid: this.currentUser.id });

                    if (error) throw error;

                    this.renderProcessingQueue(queueItems);
                } catch (error) {
                    console.error('대기열 로드 오류:', error);
                    this.showError('대기열 정보를 불러오는데 실패했습니다.');
                }
            }

            renderProcessingQueue(queueItems) {
                const container = document.getElementById('queue-list');
                container.innerHTML = '';

                if (!queueItems || queueItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--color-text-secondary);">
                            <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>처리 중인 작업이 없습니다</p>
                        </div>
                    `;
                    return;
                }

                queueItems.forEach(item => {
                    const queueDiv = document.createElement('div');
                    queueDiv.style.cssText = 'border-bottom: 1px solid var(--color-border); padding: 1.5rem 0;';

                    const createdDate = new Date(item.created_at).toLocaleDateString('ko-KR');
                    const statusClass = this.getQueueStatusClass(item.status);
                    const statusText = this.getQueueStatusText(item.status);

                    queueDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    ${this.getImageTypeLabel(item.generation_type)} 이미지 생성
                                </div>
                                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                    요청일: ${createdDate}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="progress-section" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.875rem; font-weight: 600;">진행률</span>
                                <span style="font-size: 0.875rem; color: var(--color-secondary);">${item.progress_percentage}%</span>
                            </div>
                            <div style="background: var(--color-background-secondary); border-radius: 0.5rem; height: 8px; overflow: hidden;">
                                <div style="background: var(--color-secondary); height: 100%; width: ${item.progress_percentage}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        ${item.status === 'completed' ? this.renderCompletedActions(item) : ''}
                        ${item.estimated_completion_time ? `
                            <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                                예상 완료: ${new Date(item.estimated_completion_time).toLocaleTimeString('ko-KR')}
                            </div>
                        ` : ''}
                    `;

                    container.appendChild(queueDiv);
                });
            }

            renderCompletedActions(item) {
                return `
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button onclick="app.downloadProcessedImage('${item.queue_id}')"
                                style="background: var(--color-secondary); color: white; border: none;
                                       border-radius: 0.25rem; padding: 0.5rem 1rem; cursor: pointer;
                                       font-size: 0.875rem;">
                            <i class="fas fa-download" style="margin-right: 0.25rem;"></i>다운로드
                        </button>
                        <button onclick="app.viewProcessedImage('${item.queue_id}')"
                                style="background: var(--color-primary); color: white; border: none;
                                       border-radius: 0.25rem; padding: 0.5rem 1rem; cursor: pointer;
                                       font-size: 0.875rem;">
                            <i class="fas fa-eye" style="margin-right: 0.25rem;"></i>미리보기
                        </button>
                    </div>
                `;
            }

            getQueueStatusClass(status) {
                const classes = {
                    queued: 'status-pending',
                    processing: 'status-processing',
                    completed: 'status-completed',
                    failed: 'status-failed',
                    cancelled: 'status-cancelled'
                };
                return classes[status] || 'status-pending';
            }

            getQueueStatusText(status) {
                const texts = {
                    queued: '대기 중',
                    processing: '처리 중',
                    completed: '완료',
                    failed: '실패',
                    cancelled: '취소됨'
                };
                return texts[status] || status;
            }

            async downloadProcessedImage(queueId) {
                try {
                    // Get queue item with result data
                    const { data: queueItem, error } = await this.supabase
                        .from('processing_queue')
                        .select('result_data')
                        .eq('id', queueId)
                        .single();

                    if (error) throw error;

                    if (!queueItem.result_data || !queueItem.result_data.image_url) {
                        throw new Error('처리된 이미지를 찾을 수 없습니다.');
                    }

                    // Download the image
                    const response = await fetch(queueItem.result_data.image_url);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `generated-baby-face-${queueId}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    window.URL.revokeObjectURL(url);

                    this.showSuccess('이미지가 다운로드되었습니다!');
                } catch (error) {
                    console.error('이미지 다운로드 오류:', error);
                    this.showError('이미지 다운로드에 실패했습니다.');
                }
            }

            async viewProcessedImage(queueId) {
                try {
                    // Get queue item with result data
                    const { data: queueItem, error } = await this.supabase
                        .from('processing_queue')
                        .select('result_data')
                        .eq('id', queueId)
                        .single();

                    if (error) throw error;

                    if (!queueItem.result_data || !queueItem.result_data.image_url) {
                        throw new Error('처리된 이미지를 찾을 수 없습니다.');
                    }

                    // Show image in a modal or new window
                    window.open(queueItem.result_data.image_url, '_blank');
                } catch (error) {
                    console.error('이미지 미리보기 오류:', error);
                    this.showError('이미지를 미리볼 수 없습니다.');
                }
            }

            // Purchase Functions
            async buyNow(imageIndex, imageData) {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    // Create a temporary generated image record for this purchase
                    const { data: generatedImage, error: imageError } = await this.supabase
                        .from('generated_images')
                        .insert({
                            user_id: this.currentUser.id,
                            image_url: typeof imageData === 'string' ? imageData : imageData.src,
                            thumbnail_url: typeof imageData === 'string' ? imageData : imageData.src,
                            image_type: this.inputMode,
                            generation_settings: {
                                mode: this.inputMode,
                                age: typeof imageData === 'object' ? imageData.age : null,
                                generationMode: this.generationMode,
                                comparisonType: this.comparisonType
                            },
                            price_cents: this.pricing[this.inputMode],
                            is_purchased: false
                        })
                        .select()
                        .single();

                    if (imageError) throw imageError;

                    // Create order for immediate purchase
                    await this.createOrderFromItems([{
                        image_id: generatedImage.id,
                        quantity: 1,
                        price_cents: this.pricing[this.inputMode]
                    }]);

                } catch (error) {
                    console.error('바로 결제 오류:', error);
                    this.showError('바로 결제에 실패했습니다.');
                }
            }

            async addToCart(imageIndex, imageData) {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    // Create a temporary generated image record for cart
                    const { data: generatedImage, error: imageError } = await this.supabase
                        .from('generated_images')
                        .insert({
                            user_id: this.currentUser.id,
                            image_url: typeof imageData === 'string' ? imageData : imageData.src,
                            thumbnail_url: typeof imageData === 'string' ? imageData : imageData.src,
                            image_type: this.inputMode,
                            generation_settings: {
                                mode: this.inputMode,
                                age: typeof imageData === 'object' ? imageData.age : null,
                                generationMode: this.generationMode,
                                comparisonType: this.comparisonType
                            },
                            price_cents: this.pricing[this.inputMode],
                            is_purchased: false
                        })
                        .select()
                        .single();

                    if (imageError) throw imageError;

                    // Add to cart
                    const { error: cartError } = await this.supabase
                        .from('cart_items')
                        .insert({
                            user_id: this.currentUser.id,
                            image_id: generatedImage.id,
                            quantity: 1,
                            price_cents: this.pricing[this.inputMode]
                        });

                    if (cartError) {
                        // If item already exists in cart, it will conflict due to unique constraint
                        if (cartError.code === '23505') {
                            this.showError('이미 장바구니에 담긴 이미지입니다.');
                        } else {
                            throw cartError;
                        }
                    } else {
                        this.cartItems.push({
                            id: generatedImage.id,
                            image_id: generatedImage.id,
                            user_id: this.currentUser.id,
                            quantity: 1,
                            price_cents: this.pricing[this.inputMode],
                            generated_images: generatedImage
                        });

                        this.updateCartDisplay();
                        this.showSuccess('장바구니에 추가되었습니다!');
                    }

                } catch (error) {
                    console.error('장바구니 추가 오류:', error);
                    this.showError('장바구니에 추가하는데 실패했습니다.');
                }
            }

            setupEventListeners() {
                // API 키 관리 (관리자 API로 이동되어 더 이상 필요없음)
                const saveApiKeyBtn = document.getElementById('save-api-key');
                const changeApiKeyBtn = document.getElementById('change-api-key');
                const apiKeyInput = document.getElementById('api-key-input');

                if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
                if (changeApiKeyBtn) changeApiKeyBtn.addEventListener('click', () => this.changeApiKey());
                if (apiKeyInput) {
                    apiKeyInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.saveApiKey();
                    });
                }

                // 모드 선택
                document.getElementById('ultrasound-mode').addEventListener('click', () => this.setInputMode('ultrasound'));
                document.getElementById('separate-mode').addEventListener('click', () => this.setInputMode('separate'));
                document.getElementById('together-mode').addEventListener('click', () => this.setInputMode('together'));

                // 파일 업로드
                document.getElementById('father-files').addEventListener('change', (e) => this.handleFileUpload(e, 'father'));
                document.getElementById('mother-files').addEventListener('change', (e) => this.handleFileUpload(e, 'mother'));
                document.getElementById('together-files').addEventListener('change', (e) => this.handleFileUpload(e, 'together'));
                document.getElementById('ultrasound-files').addEventListener('change', (e) => this.handleFileUpload(e, 'ultrasound'));

                // 설정
                document.getElementById('ethnicity').addEventListener('input', (e) => this.updateSetting('ethnicity', e.target.value));
                document.getElementById('nationality').addEventListener('input', (e) => this.updateSetting('nationality', e.target.value));
                document.getElementById('child-number').addEventListener('change', (e) => this.updateSetting('childNumber', parseInt(e.target.value) || 1));

                // 성별
                document.querySelectorAll('input[name="gender"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.updateSetting('gender', e.target.value));
                });

                // 생성 모드
                document.getElementById('single-age-btn').addEventListener('click', () => this.setGenerationMode('singleAge'));
                document.getElementById('age-progression-btn').addEventListener('click', () => this.setGenerationMode('ageProgression'));

                // 나이 설정
                document.getElementById('baby-age').addEventListener('change', (e) => this.updateBabyAge(e.target.value));
                document.getElementById('custom-age').addEventListener('input', (e) => this.updateSetting('customAge', e.target.value));
                document.getElementById('num-images').addEventListener('change', (e) => this.updateSetting('numberOfImages', Math.max(1, Math.min(4, parseInt(e.target.value) || 1))));
                document.getElementById('age-progression-count').addEventListener('change', (e) => this.updateSetting('ageProgressionCount', Math.max(1, Math.min(2, parseInt(e.target.value) || 1))));

                // 비교 타입
                document.querySelectorAll('input[name="comparison-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.setComparisonType(e.target.value));
                });

                // 단순 닮음 슬라이더
                document.getElementById('simple-slider').addEventListener('input', (e) => this.updateSimplePercentages(parseInt(e.target.value)));

                // 생성 버튼
                document.getElementById('generate-btn').addEventListener('click', () => this.showConfirmation());

                // 인증 버튼들
                document.getElementById('login-btn').addEventListener('click', () => this.showLoginModal());
                document.getElementById('signup-btn').addEventListener('click', () => this.showSignupModal());
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());

                // 모달 닫기 버튼들
                document.getElementById('close-login').addEventListener('click', () => this.hideLoginModal());
                document.getElementById('close-signup').addEventListener('click', () => this.hideSignupModal());
                document.getElementById('close-cart').addEventListener('click', () => this.hideCartModal());

                // 모달 전환 버튼들
                document.getElementById('switch-to-signup').addEventListener('click', () => this.switchToSignup());
                document.getElementById('switch-to-login').addEventListener('click', () => this.switchToLogin());

                // 인증 폼 제출
                // 로그인 폼 이벤트 리스너
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    console.log('✅ 로그인 폼 이벤트 리스너 연결됨');
                    loginForm.addEventListener('submit', (e) => {
                        console.log('🔄 로그인 폼 submit 이벤트 발생');
                        this.handleLogin(e);
                    });
                } else {
                    console.error('❌ 로그인 폼을 찾을 수 없습니다');
                }

                // 로그인 버튼 직접 클릭 이벤트도 추가 (백업용)
                const loginBtn = document.getElementById('login-submit-btn');
                if (loginBtn) {
                    console.log('✅ 로그인 버튼 클릭 이벤트 리스너 연결됨');
                    loginBtn.addEventListener('click', (e) => {
                        console.log('🔄 로그인 버튼 클릭 이벤트 발생');
                        // 폼 submit 이벤트가 정상적으로 발생하지 않을 경우 백업
                        if (e.target.type === 'submit') {
                            console.log('🔄 submit 타입 버튼이므로 폼 제출 처리');
                            const form = e.target.closest('form');
                            if (form) {
                                form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                            }
                        }
                    });
                } else {
                    console.error('❌ 로그인 버튼을 찾을 수 없습니다');
                }

                // 로그인 입력 필드에서 Enter 키 처리
                const loginEmailInput = document.getElementById('login-email');
                const loginPasswordInput = document.getElementById('login-password');

                if (loginEmailInput) {
                    loginEmailInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('🔄 이메일 필드에서 Enter 키 누름');
                            e.preventDefault();
                            if (loginForm) {
                                loginForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                            }
                        }
                    });
                }

                if (loginPasswordInput) {
                    loginPasswordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('🔄 비밀번호 필드에서 Enter 키 누름');
                            e.preventDefault();
                            if (loginForm) {
                                loginForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                            }
                        }
                    });
                }

                document.getElementById('signup-form').addEventListener('submit', (e) => this.handleSignup(e));

                // 소셜 로그인
                document.getElementById('google-login').addEventListener('click', () => this.loginWithGoogle());
                document.getElementById('google-signup').addEventListener('click', () => this.loginWithGoogle());

                // 장바구니 관련
                document.getElementById('cart-btn').addEventListener('click', () => this.showCartModal());
                document.getElementById('cart-floating').addEventListener('click', () => this.showCartModal());
                document.getElementById('checkout-btn').addEventListener('click', () => this.checkout());

                // 주문 이력 관련
                document.getElementById('orders-btn').addEventListener('click', () => this.showOrdersModal());
                document.getElementById('close-orders').addEventListener('click', () => this.hideOrdersModal());

                // 처리 대기열 관련
                document.getElementById('queue-btn').addEventListener('click', () => this.showQueueModal());
                document.getElementById('close-queue').addEventListener('click', () => this.hideQueueModal());

                // 확인 모달 컨트롤
                document.getElementById('close-confirmation').addEventListener('click', () => this.closeConfirmationModal());
                document.getElementById('cancel-generation').addEventListener('click', () => this.closeConfirmationModal());
                document.getElementById('add-to-cart-generation').addEventListener('click', () => this.generateAndAddToCart());
                document.getElementById('confirm-generation').addEventListener('click', () => this.generateAndPurchase());
                document.getElementById('confirmation-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'confirmation-modal') this.closeConfirmationModal();
                });

                // 결과 모달 컨트롤
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-results').addEventListener('click', () => this.closeModal());
                document.getElementById('result-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'result-modal') this.closeModal();
                });

                // 비밀번호 찾기 관련 이벤트
                document.getElementById('forgot-password-link').addEventListener('click', () => this.showForgotPasswordModal());
                document.getElementById('close-forgot-password').addEventListener('click', () => this.hideForgotPasswordModal());
                document.getElementById('back-to-login').addEventListener('click', () => this.backToLogin());
                document.getElementById('forgot-password-form').addEventListener('submit', (e) => this.handleForgotPassword(e));

                // 모달 외부 클릭으로 닫기
                document.getElementById('forgot-password-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'forgot-password-modal') this.hideForgotPasswordModal();
                });

                // 키보드 단축키
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (document.getElementById('confirmation-modal').style.display === 'flex') {
                            this.closeConfirmationModal();
                        } else if (document.getElementById('forgot-password-modal').style.display === 'flex') {
                            this.hideForgotPasswordModal();
                        } else {
                            this.closeModal();
                        }
                    }

                    // 개발자 모드 활성화: Ctrl+Shift+D
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        e.preventDefault();
                        this.toggleDevMode();
                    }
                });
            }

            checkApiKey() {
                // 관리자 API 키가 항상 사용 가능하므로 메인 앱을 표시
                document.getElementById('main-app').style.display = 'block';

                // API 키 입력 섹션이 존재하면 숨김 (제거된 경우 에러 방지)
                const apiKeySection = document.getElementById('api-key-section');
                if (apiKeySection) {
                    apiKeySection.style.display = 'none';
                }
            }

            saveApiKey() {
                const input = document.getElementById('api-key-input');
                const key = input.value.trim();

                if (!key) {
                    this.showError('API 키를 입력해주세요.');
                    return;
                }

                this.apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                input.value = '';
                this.checkApiKey();
                this.clearError();
            }

            changeApiKey() {
                this.apiKey = '';
                localStorage.removeItem('geminiApiKey');
                this.checkApiKey();
            }

            setInputMode(mode) {
                this.inputMode = mode;
                document.getElementById('ultrasound-mode').classList.toggle('active', mode === 'ultrasound');
                document.getElementById('separate-mode').classList.toggle('active', mode === 'separate');
                document.getElementById('together-mode').classList.toggle('active', mode === 'together');
                document.getElementById('ultrasound-upload').style.display = mode === 'ultrasound' ? 'block' : 'none';
                document.getElementById('separate-upload').style.display = mode === 'separate' ? 'grid' : 'none';
                document.getElementById('together-upload').style.display = mode === 'together' ? 'block' : 'none';

                // 초음파 모드에서는 닮은꼴 설정 섹션 숨기기
                const resemblanceSection = document.querySelector('.settings-grid > div:last-child');
                if (resemblanceSection) {
                    resemblanceSection.style.display = mode === 'ultrasound' ? 'none' : 'block';
                }

                // 초음파 모드에서는 생성 버튼 텍스트 변경
                const generateBtn = document.getElementById('generate-btn');
                if (mode === 'ultrasound') {
                    generateBtn.querySelector('span').textContent = '아기 얼굴 예측하기';
                } else {
                    generateBtn.querySelector('span').textContent = '아기 얼굴 예측하기';
                }

                this.updateGenerateButton();
            }

            setGenerationMode(mode) {
                this.generationMode = mode;
                document.getElementById('single-age-btn').classList.toggle('active', mode === 'singleAge');
                document.getElementById('age-progression-btn').classList.toggle('active', mode === 'ageProgression');
                document.getElementById('single-age-options').style.display = mode === 'singleAge' ? 'block' : 'none';
                document.getElementById('age-progression-options').style.display = mode === 'ageProgression' ? 'block' : 'none';
                this.updateGenerateButton();
            }

            setComparisonType(type) {
                this.comparisonType = type;
                document.getElementById('simple-resemblance').style.display = type === 'simple' ? 'block' : 'none';
                document.getElementById('detailed-resemblance').style.display = type === 'detailed' ? 'block' : 'none';
                document.getElementById('face-visualizer').style.display = type === 'detailed' ? 'flex' : 'none';
            }

            updateBabyAge(age) {
                this.updateSetting('babyAge', age);
                document.getElementById('custom-age-input').style.display = age === 'custom' ? 'block' : 'none';
            }

            updateSetting(key, value) {
                this.settings[key] = value;
                this.updateGenerateButton();
            }

            updateSimplePercentages(momPercentage) {
                this.settings.simplePercentages = {
                    mom: momPercentage,
                    dad: 100 - momPercentage
                };
                document.getElementById('mom-percentage').textContent = `엄마: ${momPercentage}%`;
                document.getElementById('dad-percentage').textContent = `아빠: ${100 - momPercentage}%`;
            }

            createPresetAgeButtons() {
                const container = document.getElementById('preset-ages');
                container.innerHTML = '';
                const ageDisplayMap = {
                    '3 months old': '3개월', '6 months old': '6개월', '1 year old': '1살', '2 years old': '2살',
                    '3 years old': '3살', '4 years old': '4살', '5 years old': '5살'
                };
                this.presetAges.forEach(age => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'preset-age-btn';
                    button.textContent = ageDisplayMap[age] || age;
                    button.addEventListener('click', () => this.togglePresetAge(age));
                    container.appendChild(button);
                });
            }

            togglePresetAge(age) {
                const index = this.settings.selectedPresetAges.indexOf(age);
                if (index > -1) {
                    this.settings.selectedPresetAges.splice(index, 1);
                } else {
                    this.settings.selectedPresetAges.push(age);
                }
                document.querySelectorAll('.preset-age-btn').forEach((btn, i) => {
                    const ageValue = this.presetAges[i];
                    btn.classList.toggle('selected', this.settings.selectedPresetAges.includes(ageValue));
                });
                this.updateGenerateButton();
            }

            createDetailedSliders() {
                const container = document.getElementById('detailed-sliders');
                container.innerHTML = '';
                this.facialFeatures.forEach(feature => {
                    const sliderDiv = document.createElement('div');
                    sliderDiv.className = 'detailed-slider-item';
                    sliderDiv.dataset.feature = feature.key;
                    sliderDiv.innerHTML = `
                        <label class="detailed-slider-label">${feature.label}</label>
                        <input type="range" min="0" max="100" value="50" class="slider" data-feature="${feature.key}">
                        <div class="detailed-percentages">
                            <span class="dad-percent">아빠: 50%</span>
                            <span class="mom-percent">엄마: 50%</span>
                        </div>
                    `;
                    const slider = sliderDiv.querySelector('.slider');
                    slider.addEventListener('input', (e) => this.updateDetailedPercentage(feature.key, parseInt(e.target.value)));
                    sliderDiv.addEventListener('mouseenter', () => this.highlightFeature(feature.key, feature.color));
                    sliderDiv.addEventListener('mouseleave', () => this.highlightFeature(null));
                    container.appendChild(sliderDiv);
                });
            }

            updateDetailedPercentage(featureKey, momPercentage) {
                const dadPercentage = 100 - momPercentage;
                this.settings.detailedPercentages[featureKey] = { mom: momPercentage, dad: dadPercentage };
                const sliderItem = document.querySelector(`[data-feature="${featureKey}"]`);
                if (sliderItem) {
                    sliderItem.querySelector('.mom-percent').textContent = `엄마: ${momPercentage}%`;
                    sliderItem.querySelector('.dad-percent').textContent = `아빠: ${dadPercentage}%`;
                }
            }

            highlightFeature(featureKey, color = null) {
                document.querySelectorAll('.detailed-slider-item').forEach(item => item.classList.remove('highlighted'));
                document.querySelectorAll('.feature-highlight').forEach(highlight => {
                    highlight.classList.remove('active');
                    highlight.style.fill = 'transparent';
                });
                if (featureKey) {
                    const sliderItem = document.querySelector(`[data-feature="${featureKey}"]`);
                    if (sliderItem) sliderItem.classList.add('highlighted');
                    const faceHighlight = document.getElementById(`${featureKey}-highlight`);
                    if (faceHighlight) {
                        faceHighlight.classList.add('active');
                        faceHighlight.style.fill = color || '#4f46e5';
                    }
                }
                this.currentHighlightedFeature = featureKey;
            }

            async handleFileUpload(event, type) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                const targetArray = type === 'father' ? this.fatherImages :
                                  type === 'mother' ? this.motherImages :
                                  type === 'together' ? this.togetherImages :
                                  this.ultrasoundImages;
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        try {
                            const imageData = await this.processImageFile(file);
                            const imageWithAge = { id: `${Date.now()}-${Math.random()}`, imageData, age: '', fatherAge: '', motherAge: '' };
                            targetArray.push(imageWithAge);
                        } catch (error) {
                            console.error('이미지 처리 오류:', error);
                            this.showError('이미지 파일 처리에 실패했습니다.');
                        }
                    }
                }
                this.renderPreviews(type);
                this.updateGenerateButton();
                event.target.value = '';
            }

            async processImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const result = e.target.result;
                        const base64String = result.split(',')[1];
                        resolve({ base64: base64String, mimeType: file.type, preview: result });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            renderPreviews(type) {
                const container = document.getElementById(`${type}-previews`);
                const images = type === 'father' ? this.fatherImages :
                              type === 'mother' ? this.motherImages :
                              type === 'together' ? this.togetherImages :
                              this.ultrasoundImages;
                container.innerHTML = '';
                images.forEach(image => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'preview-item';
                    const img = document.createElement('img');
                    img.src = image.imageData.preview;
                    img.className = 'preview-image';
                    img.alt = 'preview';
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'preview-content';
                    if (type === 'ultrasound') {
                        contentDiv.innerHTML = `
                            <div>
                                <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">초음파 사진</label>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0.25rem 0 0 0;">3D/4D 초음파 이미지</p>
                            </div>
                        `;
                    } else if (type === 'together') {
                        contentDiv.innerHTML = `
                            <div style="display: flex; gap: 0.5rem;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">아빠 나이</label>
                                    <input type="number" value="${image.fatherAge}" placeholder="예: 32" class="form-input" onchange="app.updateImageAge('${image.id}', 'fatherAge', this.value)">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">엄마 나이</label>
                                    <input type="number" value="${image.motherAge}" placeholder="예: 30" class="form-input" onchange="app.updateImageAge('${image.id}', 'motherAge', this.value)">
                                </div>
                            </div>
                        `;
                    } else {
                        contentDiv.innerHTML = `
                            <div>
                                <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">사진 속 나이</label>
                                <input type="number" value="${image.age}" placeholder="예: 28" class="form-input" onchange="app.updateImageAge('${image.id}', 'age', this.value)">
                            </div>
                        `;
                    }
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    removeBtn.onclick = () => this.removeImage(image.id, type);
                    previewDiv.appendChild(img);
                    previewDiv.appendChild(contentDiv);
                    previewDiv.appendChild(removeBtn);
                    container.appendChild(previewDiv);
                });
            }

            updateImageAge(imageId, ageType, value) {
                const allImages = [...this.fatherImages, ...this.motherImages, ...this.togetherImages, ...this.ultrasoundImages];
                const image = allImages.find(img => img.id === imageId);
                if (image) image[ageType] = value;
            }

            removeImage(imageId, type) {
                if (type === 'father') this.fatherImages = this.fatherImages.filter(img => img.id !== imageId);
                else if (type === 'mother') this.motherImages = this.motherImages.filter(img => img.id !== imageId);
                else if (type === 'together') this.togetherImages = this.togetherImages.filter(img => img.id !== imageId);
                else if (type === 'ultrasound') this.ultrasoundImages = this.ultrasoundImages.filter(img => img.id !== imageId);
                this.renderPreviews(type);
                this.updateGenerateButton();
            }

            updateGenerateButton() {
                const button = document.getElementById('generate-btn');
                const hasRequiredImages = (this.inputMode === 'separate' && this.fatherImages.length > 0 && this.motherImages.length > 0) ||
                                        (this.inputMode === 'together' && this.togetherImages.length > 0) ||
                                        (this.inputMode === 'ultrasound' && this.ultrasoundImages.length > 0);
                const hasAgeProgression = this.generationMode !== 'ageProgression' || this.settings.selectedPresetAges.length > 0;
                const isEnabled = hasRequiredImages && hasAgeProgression && !this.isLoading;
                button.disabled = !isEnabled;
                button.querySelector('span').textContent = this.isLoading ? '생성 중...' : "아기 얼굴 예측하기";
            }

            showConfirmationModal() {
                // 요약 내용 생성
                const summary = this.generateRequestSummary();
                document.getElementById('request-summary').innerHTML = summary;

                // 확인 모달 표시
                document.getElementById('confirmation-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            generateRequestSummary() {
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // 사진 정보
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">📷 업로드된 사진</h4>';
                if (this.inputMode === 'separate') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">아빠 사진 ${this.fatherImages.length}장, 엄마 사진 ${this.motherImages.length}장</p>`;
                } else if (this.inputMode === 'together') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">부모님 함께 사진 ${this.togetherImages.length}장</p>`;
                } else if (this.inputMode === 'ultrasound') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">초음파 사진 ${this.ultrasoundImages.length}장</p>`;
                }
                html += '</div>';

                // 아기 정보
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">👶 아기 정보</h4>';
                const childNumber = this.settings.childNumber;
                const ordinal = childNumber === 1 ? '첫' : childNumber === 2 ? '둘' : childNumber === 3 ? '셋' : `${childNumber}번`;
                const genderText = this.settings.gender === 'Male' ? '남자아이' : '여자아이';
                html += `<p style="margin: 0; font-size: 0.875rem;">${ordinal}째 ${genderText}`;
                if (this.settings.ethnicity) html += `, ${this.settings.ethnicity}`;
                if (this.settings.nationality) html += `, ${this.settings.nationality}`;
                html += '</p></div>';

                // 생성 설정
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">⚙️ 생성 설정</h4>';
                if (this.generationMode === 'singleAge') {
                    const age = this.settings.babyAge === 'custom' ? `${this.settings.customAge}살` :
                              this.settings.babyAge === 'Newborn' ? '신생아' :
                              this.settings.babyAge.replace(' years old', '살').replace(' year old', '살');
                    html += `<p style="margin: 0; font-size: 0.875rem;">${age} 사진 ${this.settings.numberOfImages}장 생성</p>`;
                } else {
                    const ageDisplayMap = {
                        '3 months old': '3개월', '6 months old': '6개월', '1 year old': '1살',
                        '2 years old': '2살', '3 years old': '3살', '4 years old': '4살', '5 years old': '5살'
                    };
                    const selectedAgesText = this.settings.selectedPresetAges.map(age => ageDisplayMap[age] || age).join(', ');
                    const totalImages = this.settings.selectedPresetAges.length * this.settings.ageProgressionCount;
                    html += `<p style="margin: 0; font-size: 0.875rem;">성장 과정: ${selectedAgesText}</p>`;
                    html += `<p style="margin: 0; font-size: 0.875rem;">나이별 ${this.settings.ageProgressionCount}장씩, 총 ${totalImages}장 생성</p>`;
                }
                html += '</div>';

                // 닮음 설정
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">👥 닮음 설정</h4>';
                if (this.comparisonType === 'simple') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">전체적으로 엄마 ${this.settings.simplePercentages.mom}%, 아빠 ${this.settings.simplePercentages.dad}%</p>`;
                } else {
                    html += '<p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">부위별 상세 설정:</p>';
                    html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem; font-size: 0.75rem; color: var(--color-text-secondary);">';
                    this.facialFeatures.forEach(feature => {
                        const percentages = this.settings.detailedPercentages[feature.key];
                        if (percentages && (percentages.mom !== 50 || percentages.dad !== 50)) {
                            html += `<div>${feature.label}: 엄마 ${percentages.mom}%, 아빠 ${percentages.dad}%</div>`;
                        }
                    });
                    html += '</div>';
                }
                html += '</div>';

                html += '</div>';
                return html;
            }

            closeConfirmationModal() {
                document.getElementById('confirmation-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            showConfirmation() {
                // 입력 검증
                if ((this.inputMode === 'separate' && (this.fatherImages.length === 0 || this.motherImages.length === 0)) ||
                    (this.inputMode === 'together' && this.togetherImages.length === 0) ||
                    (this.inputMode === 'ultrasound' && this.ultrasoundImages.length === 0)) {
                    this.showError('각 카테고리에 최소 한 장의 사진을 업로드해주세요.');
                    return;
                }
                if (this.generationMode === 'ageProgression' && this.settings.selectedPresetAges.length === 0) {
                    this.showError('성장 과정 모드에서는 최소 한 개의 나이를 선택해야 합니다.');
                    return;
                }

                this.clearError();
                this.showConfirmationModal();
            }

            async generateBabyFace() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.closeConfirmationModal();
                this.showModal();
                this.updateGenerateButton();

                try {
                    let generatedImages = [];
                    if (this.generationMode === 'singleAge') {
                        const age = this.settings.babyAge === 'custom' ? `${this.settings.customAge} years old` : this.settings.babyAge;
                        const results = await this.callGeminiAPI({ age, numberOfImages: this.settings.numberOfImages });
                        generatedImages = results;
                    } else {
                        for (const age of this.settings.selectedPresetAges) {
                            const resultsForAge = await this.callGeminiAPI({ age, numberOfImages: this.settings.ageProgressionCount });
                            generatedImages.push(...resultsForAge.map(img => ({ src: img, age })));
                        }
                    }
                    this.displayResults(generatedImages);
                } catch (error) {
                    console.error('생성 오류:', error);
                    this.showErrorState(error.message || '아기 얼굴 생성에 실패했습니다. 다시 시도해주세요.');
                } finally {
                    this.isLoading = false;
                    this.updateGenerateButton();
                }
            }

            // 즉시 결제 및 생성
            async generateAndPurchase() {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    this.closeConfirmationModal();

                    // 1. 먼저 결제 정보 생성
                    const imagePrice = 500; // 500원
                    const totalImages = this.calculateTotalImages();
                    const totalAmount = totalImages * imagePrice;

                    // 2. 즉시 결제 처리
                    const paymentResult = await this.processDirectPayment(totalAmount, totalImages);

                    if (!paymentResult.success) {
                        throw new Error('결제에 실패했습니다.');
                    }

                    console.log('✅ 결제 완료 확인:', paymentResult);

                    // 3. 결제 완료 후 이미지 생성 API 호출
                    const generatedImages = await this.generateImagesOnly();

                    // 4. 생성된 이미지를 처리 대기열에 추가
                    await this.addToProcessingQueue(paymentResult.orderId, generatedImages);

                    this.showSuccess('결제가 완료되었습니다! 이미지 생성이 시작되었습니다.');

                    // 5. 처리 현황 모달 표시
                    this.showProcessingQueueModal();

                } catch (error) {
                    console.error('즉시 결제 및 생성 오류:', error);
                    this.showError(error.message || '즉시 결제 및 생성에 실패했습니다.');
                }
            }

            // 장바구니에 추가
            async generateAndAddToCart() {
                if (!this.isAuthenticated) {
                    this.showLoginModal();
                    return;
                }

                try {
                    this.closeConfirmationModal();

                    // 1. 장바구니에 항목 추가 (이미지 생성 전)
                    const imagePrice = 500; // 500원
                    const totalImages = this.calculateTotalImages();

                    // 현재 설정을 기반으로 장바구니 항목 생성
                    const cartItem = {
                        type: this.inputMode,
                        settings: this.getCurrentGenerationSettings(),
                        price: imagePrice,
                        quantity: totalImages,
                        total: totalImages * imagePrice,
                        timestamp: Date.now()
                    };

                    // 장바구니에 추가
                    await this.addItemToCart(cartItem);

                    this.showSuccess('장바구니에 추가되었습니다!');

                    // 2. 장바구니 모달 표시
                    this.showCartModal();

                } catch (error) {
                    console.error('장바구니 추가 오류:', error);
                    this.showError('장바구니 추가에 실패했습니다.');
                }
            }

            // 이미지만 생성하는 함수 (UI 표시 없이)
            async generateImagesOnly() {
                this.isLoading = true;
                this.updateGenerateButton();

                // API 키 확인 및 재로드
                if (!this.apiKey) {
                    console.log('🔑 API 키 재로드 중...');
                    this.apiKey = await this.getSecureApiKey();
                }

                if (!this.apiKey) {
                    throw new Error('API 키를 찾을 수 없습니다. 관리자에게 문의하세요.');
                }

                try {
                    let generatedImages = [];
                    if (this.generationMode === 'singleAge') {
                        const age = this.settings.babyAge === 'custom' ? `${this.settings.customAge} years old` : this.settings.babyAge;
                        const results = await this.callGeminiAPI({ age, numberOfImages: this.settings.numberOfImages });
                        generatedImages = results;
                    } else {
                        for (const age of this.settings.selectedPresetAges) {
                            const resultsForAge = await this.callGeminiAPI({ age, numberOfImages: this.settings.ageProgressionCount });
                            generatedImages.push(...resultsForAge.map(img => ({ src: img, age })));
                        }
                    }
                    return generatedImages;
                } catch (error) {
                    console.error('이미지 생성 오류:', error);
                    throw error;
                } finally {
                    this.isLoading = false;
                    this.updateGenerateButton();
                }
            }

            // 총 이미지 수 계산
            calculateTotalImages() {
                if (this.generationMode === 'singleAge') {
                    return this.settings.numberOfImages;
                } else {
                    return this.settings.selectedPresetAges.length * this.settings.ageProgressionCount;
                }
            }

            // 현재 생성 설정을 가져오는 함수
            getCurrentGenerationSettings() {
                return {
                    inputMode: this.inputMode,
                    generationMode: this.generationMode,
                    babyAge: this.settings.babyAge,
                    customAge: this.settings.customAge,
                    numberOfImages: this.settings.numberOfImages,
                    selectedPresetAges: this.settings.selectedPresetAges,
                    ageProgressionCount: this.settings.ageProgressionCount,
                    comparisonType: this.comparisonType,
                    simplePercentages: this.settings.simplePercentages,
                    detailedPercentages: this.settings.detailedPercentages
                };
            }

            // 즉시 결제 처리
            async processDirectPayment(totalAmount, imageCount) {
                try {
                    console.log(`💳 즉시 결제 처리 시작: ${totalAmount}원 (${imageCount}장)`);

                    // 1. 먼저 주문 생성
                    const { data: order, error: orderError } = await this.supabase
                        .rpc('create_order_from_cart', {
                            user_uuid: this.currentUser.id
                        });

                    if (orderError) {
                        // 장바구니가 비어있다면 즉시 주문 생성
                        const { data: newOrder, error: newOrderError } = await this.supabase
                            .from('orders')
                            .insert([{
                                user_id: this.currentUser.id,
                                order_number: `MYB-${Date.now()}`,
                                total_amount_cents: totalAmount,
                                status: 'pending'
                            }])
                            .select()
                            .single();

                        if (newOrderError) throw newOrderError;
                        var orderId = newOrder.id;
                    } else {
                        var orderId = order;
                    }

                    console.log('📋 주문 생성됨:', orderId);

                    // 2. 현재 생성 설정을 임시 저장 (결제 완료 후 복원용)
                    const generationSettings = this.getCurrentGenerationSettings();
                    sessionStorage.setItem('pendingGeneration', JSON.stringify({
                        orderId: orderId,
                        settings: generationSettings,
                        timestamp: Date.now()
                    }));

                    // 3. Polar Payment API를 통한 즉시 결제
                    const orderData = {
                        product: {
                            name: `AI 아기 얼굴 예측 - ${imageCount}장`,
                            price: totalAmount
                        },
                        success_url: `${window.location.origin}?payment=success&order=${orderId}&type=direct`,
                        cancel_url: `${window.location.origin}?payment=cancel&order=${orderId}`,
                        currency: 'KRW'
                    };

                    const checkoutResponse = await this.createPolarCheckout(orderData);

                    if (!checkoutResponse.success) {
                        throw new Error('결제 세션 생성에 실패했습니다.');
                    }

                    // 4. 결제 페이지로 리다이렉트
                    window.location.href = checkoutResponse.checkout_url;

                    return {
                        success: true,
                        orderId: orderId,
                        checkoutUrl: checkoutResponse.checkout_url
                    };

                } catch (error) {
                    console.error('즉시 결제 처리 오류:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            // 장바구니에 항목 추가
            async addItemToCart(cartItem) {
                try {
                    // 개발 모드 사용자인 경우 로컬 스토리지 사용
                    if (this.currentUser.isDevelopmentUser) {
                        console.log('🔧 개발 모드 - 로컬 장바구니 사용');
                        const localCart = JSON.parse(localStorage.getItem('dev_cart_items') || '[]');
                        const newItem = {
                            id: 'dev-cart-' + Date.now(),
                            user_id: this.currentUser.id,
                            item_data: cartItem,
                            price_cents: cartItem.total,
                            quantity: cartItem.quantity,
                            added_at: new Date().toISOString()
                        };
                        localCart.push(newItem);
                        localStorage.setItem('dev_cart_items', JSON.stringify(localCart));
                        console.log('✅ 개발 모드 장바구니 추가 성공:', newItem);
                        return;
                    }

                    const { data, error } = await this.supabase
                        .from('cart_items')
                        .insert([{
                            user_id: this.currentUser.id,
                            item_data: cartItem,
                            price_cents: cartItem.total,
                            quantity: cartItem.quantity
                        }]);

                    if (error) throw error;

                    // 로컬 장바구니도 업데이트
                    this.cartItems.push(cartItem);
                    this.updateCartDisplay();

                    console.log('✅ 장바구니에 추가됨:', cartItem);

                } catch (error) {
                    console.error('장바구니 추가 오류:', error);
                    throw error;
                }
            }

            // 처리 대기열에 추가
            async addToProcessingQueue(orderId, generatedImages) {
                try {
                    const queueData = {
                        user_id: this.currentUser.id,
                        order_id: orderId,
                        generation_type: this.inputMode,
                        generation_params: this.getCurrentGenerationSettings(),
                        result_data: {
                            images: generatedImages,
                            generated_at: new Date().toISOString()
                        }
                    };

                    const { data, error } = await this.supabase
                        .rpc('add_to_processing_queue', {
                            user_uuid: this.currentUser.id,
                            order_uuid: orderId,
                            gen_type: this.inputMode,
                            gen_params: queueData.generation_params
                        });

                    if (error) throw error;

                    console.log('✅ 처리 대기열에 추가됨:', data);
                    return data;

                } catch (error) {
                    console.error('처리 대기열 추가 오류:', error);
                    throw error;
                }
            }

            // 생성 설정 복원 함수
            restoreGenerationSettings(settings) {
                try {
                    console.log('🔄 생성 설정 복원:', settings);

                    // 기본 설정 복원
                    this.inputMode = settings.inputMode;
                    this.generationMode = settings.generationMode;
                    this.comparisonType = settings.comparisonType;

                    // 세부 설정 복원
                    this.settings = {
                        ...this.settings,
                        babyAge: settings.babyAge,
                        customAge: settings.customAge,
                        numberOfImages: settings.numberOfImages,
                        selectedPresetAges: settings.selectedPresetAges || [],
                        ageProgressionCount: settings.ageProgressionCount,
                        simplePercentages: settings.simplePercentages || { mom: 50, dad: 50 },
                        detailedPercentages: settings.detailedPercentages || {}
                    };

                    console.log('✅ 설정 복원 완료');
                } catch (error) {
                    console.error('설정 복원 오류:', error);
                    // 기본값으로 설정
                    this.setDefaultSettings();
                }
            }

            // 기본 설정으로 초기화
            setDefaultSettings() {
                this.inputMode = 'separate';
                this.generationMode = 'singleAge';
                this.comparisonType = 'simple';
                this.settings = {
                    babyAge: 'Newborn',
                    numberOfImages: 1,
                    selectedPresetAges: [],
                    ageProgressionCount: 1,
                    simplePercentages: { mom: 50, dad: 50 },
                    detailedPercentages: {}
                };
            }

            async callGeminiAPI(params) {
                const { age, numberOfImages } = params;
                const prompt = this.buildPrompt(age);
                const parts = [];
                if (this.inputMode === 'ultrasound' && this.ultrasoundImages.length > 0) {
                    this.ultrasoundImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: 'This is a 3D/4D ultrasound image showing the baby in the womb.' });
                    });
                } else if (this.inputMode === 'together' && this.togetherImages.length > 0) {
                    this.togetherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        let ageText = "This photo shows father and mother together";
                        if (img.fatherAge && img.motherAge) ageText += `, father around ${img.fatherAge} years old, mother around ${img.motherAge} years old.`;
                        else if (img.fatherAge) ageText += `, father around ${img.fatherAge} years old.`;
                        else if (img.motherAge) ageText += `, mother around ${img.motherAge} years old.`;
                        else ageText += '.';
                        parts.push({ text: ageText });
                    });
                } else if (this.fatherImages.length > 0 && this.motherImages.length > 0) {
                    this.fatherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: `Father at around ${img.age || 'unknown'} years old.` });
                    });
                    this.motherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: `Mother at around ${img.age || 'unknown'} years old.` });
                    });
                }
                parts.push({ text: prompt });
                const generatedImages = [];

                for (let i = 0; i < numberOfImages; i++) {
                    if (i > 0) await new Promise(resolve => setTimeout(resolve, 4000));

                    let success = false;
                    let lastError = null;

                    // 최대 3번 재시도
                    for (let retryCount = 0; retryCount < 3 && !success; retryCount++) {
                        if (retryCount > 0) {
                            console.log(`재시도 ${retryCount}/${numberOfImages}번째 이미지...`);
                            await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // 지연 시간 증가
                        }

                        try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${this.apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts }],
                                    generationConfig: {
                                        temperature: 0.4 + (retryCount * 0.1), // 재시도마다 약간씩 변경
                                        topP: 0.8,
                                        topK: 40
                                    }
                                })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();

                                if (response.status === 429) {
                                    throw new Error(`⚠️ API 할당량 초과!\n\n무료 API 키는 요청 횟수가 제한되어 있습니다. 문제가 계속되면 다음을 시도해보세요:\n1. 24시간 후 재시도\n2. Google AI Studio에서 새 API 키 생성\n3. Google Cloud에서 유료 결제 계정 연결`);
                                }

                                if (response.status === 500) {
                                    lastError = new Error(`Google 서버 오류 (시도 ${retryCount + 1}/3). ${retryCount < 2 ? '재시도 중...' : '재시도 한계 도달.'}`);
                                    continue; // 500 에러는 재시도
                                }

                                let error;
                                try { error = JSON.parse(errorText); } catch { error = { error: { message: errorText } }; }
                                throw new Error(error.error?.message || `API 요청 실패 (${response.status})`);
                            }
                            const data = await response.json();
                            console.log('API 응답 데이터:', data); // 디버깅용

                            if (!data.candidates || data.candidates.length === 0) {
                                lastError = new Error('모델로부터 응답을 받지 못했습니다.');
                                continue; // 재시도
                            }

                            const candidate = data.candidates[0];
                            if (!candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                                lastError = new Error('모델 응답에 콘텐츠가 없습니다.');
                                continue; // 재시도
                            }

                            const imagePart = candidate.content.parts.find(p => p.inlineData || p.inline_data);
                            if (imagePart) {
                                const inlineData = imagePart.inlineData || imagePart.inline_data;
                                generatedImages.push(`data:${inlineData.mimeType || inlineData.mime_type};base64,${inlineData.data}`);
                                success = true; // 성공!
                            } else {
                                const textPart = candidate.content.parts.find(p => p.text);
                                if (textPart) {
                                    console.warn(`시도 ${i + 1}-${retryCount + 1}: 모델이 텍스트로 응답했습니다:`, textPart.text);
                                    lastError = new Error(`모델이 이미지 대신 텍스트를 반환했습니다. (시도 ${retryCount + 1}/3)`);
                                    continue; // 재시도
                                } else {
                                    console.log('사용 가능한 parts:', candidate.content.parts);
                                    lastError = new Error('모델 응답에서 이미지를 찾을 수 없습니다.');
                                    continue; // 재시도
                                }
                            }

                        } catch (error) {
                            console.error(`재시도 ${retryCount + 1} 실패:`, error);
                            lastError = error;

                            // 치명적인 오류는 즉시 중단
                            if (error.message.includes('할당량 초과') || error.message.includes('quota')) {
                                throw error;
                            }
                        }
                    }

                    // 모든 재시도가 실패한 경우
                    if (!success) {
                        throw lastError || new Error(`${i + 1}번째 이미지 생성에 실패했습니다.`);
                    }
                }
                return generatedImages;
            }
            
            buildPrompt(age) {
                if (this.inputMode === 'ultrasound') {
                    // 초음파 모드용 특별한 프롬프트
                    const nationality = this.settings.nationality || 'Korean';
                    const gender = this.settings.gender === 'Male' ? 'male' : 'female';
                    const ethnicity = this.settings.ethnicity || '';

                    let prompt = `Analyze the uploaded ultrasound image as the primary reference for the baby's pose and angle. Generate a single, photorealistic, high-detail image of a healthy and adorable ${age} baby, perfectly matching the exact angle, orientation, and posture of the fetus in the ultrasound.

BABY SPECIFICATIONS:
- The baby should be of ${nationality} nationality
- Gender: ${gender}
- Age: ${age}`;

                    if (ethnicity) {
                        prompt += `\n- Ethnicity: ${ethnicity}`;
                    }

                    prompt += `

VISUAL REQUIREMENTS:
- The baby is dressed in a cozy, soft-knitted onesie in a delicate pastel color palette (light pinks, baby blues, and mint greens)
- The lighting should be soft, warm, and natural, as if from a nearby window, creating a gentle and loving atmosphere
- The background should be a clean, simple, and slightly out-of-focus nursery setting in complementary pastel tones
- Capture this with the quality of a professional portrait photograph, using a shallow depth of field to emphasize the baby
- The baby's skin should look soft and natural, with realistic textures
- The overall mood should be peaceful, heartwarming, and full of tenderness

CRITICAL POSITIONING:
- Maintain the EXACT same angle, head position, and facial orientation as shown in the ultrasound
- Transform the ultrasound features into a realistic baby appearance while preserving the identical pose
- Keep the same facial structure and features visible in the ultrasound

Generate only the image without any text descriptions, explanations, or confirmations. The result should be a professional-quality baby portrait that perfectly matches the ultrasound's angle and position.`;

                    return prompt;
                }

                // 기존 부모 사진 기반 프롬프트
                let prompt = `IMPORTANT: Generate only a photorealistic image. Do not provide text explanations or descriptions.

Based on the provided parent photos, create a realistic child's face photo combining their facial features.

CHILD SPECIFICATIONS:
- Gender: ${this.settings.gender === 'Male' ? 'Male' : 'Female'}
- Age: ${age}
- Birth order: ${this.settings.childNumber === 1 ? 'First child' : `${this.settings.childNumber} child`}`;

                if (this.settings.ethnicity) prompt += `\n- Ethnicity: ${this.settings.ethnicity}`;
                if (this.settings.nationality) prompt += `\n- Nationality: ${this.settings.nationality}`;

                prompt += '\n\nFACIAL FEATURE BLENDING:';
                if (this.comparisonType === 'simple') {
                    prompt += `\n- Overall appearance: ${this.settings.simplePercentages.mom}% mother, ${this.settings.simplePercentages.dad}% father`;
                } else {
                    prompt += '\nSpecific feature ratios:';
                    this.facialFeatures.forEach(feature => {
                        const percentages = this.settings.detailedPercentages[feature.key];
                        if (percentages && (percentages.mom !== 50 || percentages.dad !== 50)) {
                            prompt += `\n- ${feature.label}: ${percentages.mom}% mother, ${percentages.dad}% father`;
                        }
                    });
                }

                prompt += `\n\nGenerate a high-quality, photorealistic portrait photograph showing the child's face and upper shoulders. The image should look like a natural family photo with soft, even lighting. Do not include any text, labels, or annotations in the image.

CRITICAL: Respond with only the generated image. Do not provide text descriptions, explanations, or confirmations.`;

                return prompt;
            }

            showModal() {
                document.getElementById('result-modal').style.display = 'flex';
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'none';
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('result-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            showErrorState(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-details').textContent = message;
            }

            displayResults(images) {
                if (!images || images.length === 0) return;
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'grid';
                const resultsGrid = document.getElementById('results-grid');

                if (this.inputMode === 'ultrasound') {
                    // 초음파 모드: 원본-결과 비교 뷰
                    resultsGrid.className = 'results-grid single';
                    resultsGrid.innerHTML = '';

                    images.forEach((imageData, index) => {
                        const comparisonContainer = document.createElement('div');
                        comparisonContainer.className = 'ultrasound-comparison';

                        // 원본 초음파 이미지
                        const originalSection = document.createElement('div');
                        originalSection.className = 'comparison-section';
                        originalSection.innerHTML = `
                            <div class="comparison-header">원본 초음파 사진</div>
                            <img src="${this.ultrasoundImages[0].imageData.preview}" alt="원본 초음파" class="comparison-image">
                            <div class="comparison-footer">
                                <button class="download-btn" onclick="app.downloadImage('${this.ultrasoundImages[0].imageData.preview}', 'original')">
                                    <i class="fas fa-download" style="margin-right: 0.5rem;"></i>원본 다운로드
                                </button>
                            </div>
                        `;

                        // 생성된 아기 이미지
                        const generatedSection = document.createElement('div');
                        generatedSection.className = 'comparison-section';
                        const imgSrc = typeof imageData === 'string' ? imageData : imageData.src;
                        let ageDisplay = '';
                        if (typeof imageData === 'object' && imageData.age) {
                            ageDisplay = imageData.age.replace(' old', '살').replace(' year', '살').replace(' months', '개월');
                        }
                        generatedSection.innerHTML = `
                            <div class="comparison-header">예측된 아기 모습 ${ageDisplay ? `(${ageDisplay})` : ''}</div>
                            <img src="${imgSrc}" alt="생성된 아기" class="comparison-image">
                            <div class="comparison-footer">
                                <div class="price-tag">${this.formatPrice(this.pricing[this.inputMode])}</div>
                                <div class="purchase-buttons">
                                    <button class="purchase-btn buy-now" onclick="app.buyNow('${index}', ${JSON.stringify(imageData).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-credit-card" style="margin-right: 0.25rem;"></i>바로 결제
                                    </button>
                                    <button class="purchase-btn add-cart" onclick="app.addToCart('${index}', ${JSON.stringify(imageData).replace(/"/g, '&quot;')})">
                                        <i class="fas fa-cart-plus" style="margin-right: 0.25rem;"></i>장바구니
                                    </button>
                                    <button class="purchase-btn cancel" onclick="app.cancelPurchase()">
                                        <i class="fas fa-times" style="margin-right: 0.25rem;"></i>취소
                                    </button>
                                </div>
                                <button class="download-btn" onclick="app.downloadImage('${imgSrc}', ${index})" style="margin-top: 0.5rem;">
                                    <i class="fas fa-download" style="margin-right: 0.5rem;"></i>미리보기 다운로드
                                </button>
                            </div>
                        `;

                        comparisonContainer.appendChild(originalSection);
                        comparisonContainer.appendChild(generatedSection);
                        resultsGrid.appendChild(comparisonContainer);
                    });
                } else {
                    // 기존 모드: 일반 그리드 뷰
                    resultsGrid.className = `results-grid ${images.length === 1 ? 'single' : 'multiple'}`;
                    resultsGrid.innerHTML = '';
                    images.forEach((imageData, index) => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        const img = document.createElement('img');
                        img.src = typeof imageData === 'string' ? imageData : imageData.src;
                        img.alt = `생성된 아기 ${index + 1}`;
                        img.className = 'result-image';
                        // 가격 표시
                        const priceTag = document.createElement('div');
                        priceTag.className = 'price-tag';
                        priceTag.textContent = this.formatPrice(this.pricing[this.inputMode]);

                        // 구매 버튼들
                        const purchaseButtons = document.createElement('div');
                        purchaseButtons.className = 'purchase-buttons';

                        const buyNowBtn = document.createElement('button');
                        buyNowBtn.className = 'purchase-btn buy-now';
                        buyNowBtn.innerHTML = '<i class="fas fa-credit-card" style="margin-right: 0.25rem;"></i>바로 결제';
                        buyNowBtn.onclick = () => this.buyNow(index, imageData);

                        const addCartBtn = document.createElement('button');
                        addCartBtn.className = 'purchase-btn add-cart';
                        addCartBtn.innerHTML = '<i class="fas fa-cart-plus" style="margin-right: 0.25rem;"></i>장바구니';
                        addCartBtn.onclick = () => this.addToCart(index, imageData);

                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'purchase-btn cancel';
                        cancelBtn.innerHTML = '<i class="fas fa-times" style="margin-right: 0.25rem;"></i>취소';
                        cancelBtn.onclick = () => this.cancelPurchase();

                        purchaseButtons.appendChild(buyNowBtn);
                        purchaseButtons.appendChild(addCartBtn);
                        purchaseButtons.appendChild(cancelBtn);

                        // 다운로드 버튼
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-btn';
                        downloadBtn.style.marginTop = '0.5rem';
                        let btnText = `<i class="fas fa-download" style="margin-right: 0.5rem;"></i>미리보기 다운로드`;
                        if (typeof imageData === 'object' && imageData.age) {
                            const ageDisplay = imageData.age.replace(' old', '살').replace(' year', '살').replace(' months', '개월');
                            btnText += ` (${ageDisplay})`;
                        }
                        downloadBtn.innerHTML = btnText;
                        downloadBtn.onclick = () => this.downloadImage(img.src, index);

                        resultItem.appendChild(img);
                        resultItem.appendChild(priceTag);
                        resultItem.appendChild(purchaseButtons);
                        resultItem.appendChild(downloadBtn);
                        resultsGrid.appendChild(resultItem);
                    });
                }
            }

            downloadImage(imageDataUrl, index) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                const fileExtension = imageDataUrl.split(';')[0].split('/')[1] || 'png';

                let filename;
                if (index === 'original') {
                    filename = `ultrasound-original.${fileExtension}`;
                } else if (this.inputMode === 'ultrasound') {
                    filename = `ultrasound-prediction-${index + 1}.${fileExtension}`;
                } else {
                    filename = `baby-prediction-${index + 1}.${fileExtension}`;
                }

                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showError(message) {
                const errorElement = document.getElementById('error-message');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => this.clearError(), 5000);
            }



            clearError() {
                const errorElement = document.getElementById('error-message');
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }

            cancelPurchase() {
                // 결과창을 숨기고 초기 상태로 돌아가기
                document.getElementById('results-grid').style.display = 'none';
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';

                // 파일 입력 초기화
                this.fatherImages = [];
                this.motherImages = [];
                this.ultrasoundImages = [];

                // 미리보기 업데이트
                this.renderPreviews();

                // 생성 버튼 상태 업데이트
                this.updateGenerateButton();

                // 성공 메시지 표시
                this.showSuccess('생성을 취소했습니다. 새로운 이미지를 업로드해주세요.');
            }

            updateUI() {
                this.updateGenerateButton();
                document.querySelector('input[name="gender"][value="Female"]').checked = true;
            }

            // 로그인 오류 메시지 표시/숨기기
            showLoginError(message) {
                const errorDiv = document.getElementById('login-error');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }

            hideLoginError() {
                const errorDiv = document.getElementById('login-error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }

            // 비밀번호 찾기 모달 표시/숨기기
            showForgotPasswordModal() {
                this.hideLoginModal();
                document.getElementById('forgot-password-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            hideForgotPasswordModal() {
                document.getElementById('forgot-password-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
                this.hideForgotError();
            }

            backToLogin() {
                this.hideForgotPasswordModal();
                this.showLoginModal();
            }

            // 비밀번호 찾기 오류 메시지 표시/숨기기
            showForgotError(message) {
                const errorDiv = document.getElementById('forgot-error');
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            }

            hideForgotError() {
                const errorDiv = document.getElementById('forgot-error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }

            // 이메일 확인 재전송
            async resendConfirmationEmail(email) {
                try {
                    console.log('📧 확인 이메일 재전송 중:', email);

                    // 재전송 전 상태 메시지 표시
                    this.showSuccess('이메일을 재전송하고 있습니다...');

                    const { data, error } = await this.supabase.auth.resend({
                        type: 'signup',
                        email,
                        options: {
                            emailRedirectTo: `${window.location.origin}?confirmed=true`
                        }
                    });

                    console.log('📨 재전송 응답:', { data, error });

                    if (error) {
                        console.error('❌ 이메일 재전송 오류:', error);
                        if (error.message.includes('Email rate limit exceeded')) {
                            this.showError('이메일 전송 한도를 초과했습니다. 잠시 후 다시 시도해주세요.');
                        } else if (error.message.includes('User not found')) {
                            this.showError('해당 이메일로 가입된 계정을 찾을 수 없습니다.');
                        } else if (error.message.includes('Email already confirmed')) {
                            this.showSuccess('이미 이메일 확인이 완료된 계정입니다. 로그인해주세요.');
                        } else {
                            this.showError(`이메일 재전송에 실패했습니다: ${error.message}`);
                        }
                        return;
                    }

                    console.log('✅ 확인 이메일 재전송 성공');
                    this.showSuccess(`확인 이메일을 ${email}로 다시 전송했습니다!\n\n📧 이메일을 확인하고 링크를 클릭해주세요.\n\n⚠️ 이메일이 오지 않는다면:\n• 스팸함을 확인해주세요\n• 몇 분 정도 기다려주세요\n• 이메일 주소가 정확한지 확인해주세요`);

                    // 추가 재전송 옵션 제공
                    setTimeout(() => {
                        if (confirm('여전히 이메일이 오지 않으셨나요?\n\n다른 이메일 주소로 다시 가입하거나 관리자에게 문의하시겠습니까?')) {
                            this.showError('이메일 전송에 지속적인 문제가 있는 것 같습니다.\n\n해결 방법:\n1. 다른 이메일 주소로 가입 시도\n2. 관리자에게 문의\n3. 잠시 후 다시 시도');
                        }
                    }, 30000); // 30초 후 추가 옵션 제공

                } catch (error) {
                    console.error('💥 이메일 재전송 예외:', error);
                    this.showError(`이메일 재전송 중 오류가 발생했습니다: ${error.message}`);
                }
            }

            // 개발자 모드 토글
            toggleDevMode() {
                const devModeOptions = document.getElementById('dev-mode-options');
                if (devModeOptions) {
                    const isVisible = devModeOptions.style.display !== 'none';
                    devModeOptions.style.display = isVisible ? 'none' : 'block';

                    if (!isVisible) {
                        console.log('🔧 개발자 모드 활성화됨');
                        this.showSuccess('개발자 모드가 활성화되었습니다!\n\n회원가입 시 이메일 확인을 건너뛸 수 있습니다.\n\n빠른 테스트 로그인:\n- 이메일: dev@test.com\n- 비밀번호: test123456');

                        // 빠른 테스트 계정 생성
                        this.createDevTestAccount();
                    } else {
                        console.log('🔧 개발자 모드 비활성화됨');
                    }
                }
            }

            // 개발자 모드 테스트 계정 생성
            async createDevTestAccount() {
                try {
                    const testEmail = 'dev@test.com';
                    const testPassword = 'test123456';

                    console.log('🔧 개발자 테스트 계정 생성 시도');

                    // 개발 모드에서는 가짜 사용자로 로그인 우회
                    if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                        console.log('🔧 개발 환경 감지 - 임시 사용자 생성');
                        this.currentUser = {
                            id: 'dev-user-' + Date.now(),
                            email: testEmail,
                            user_metadata: {},
                            app_metadata: {},
                            isDevelopmentUser: true
                        };

                        // 인증 상태 직접 설정
                        this.isAuthenticated = true;

                        // 로그인 상태 UI 업데이트
                        this.updateAuthUI();
                        this.loadCartItems();
                        this.showSuccess('🔧 개발 모드 임시 로그인 성공!\n\n이제 모든 기능을 테스트할 수 있습니다.');
                        return;
                    }

                    // 일반 로그인 시도
                    const { data: loginData, error: loginError } = await this.supabase.auth.signInWithPassword({
                        email: testEmail,
                        password: testPassword
                    });

                    if (loginData.user) {
                        console.log('✅ 개발자 테스트 계정 로그인 성공');
                        return;
                    }

                    // 로그인 실패 시 계정 생성
                    console.log('🔧 개발자 테스트 계정 생성 중...');
                    const { data: signupData, error: signupError } = await this.supabase.auth.signUp({
                        email: testEmail,
                        password: testPassword,
                        options: {
                            data: {
                                skipEmailVerification: true
                            }
                        }
                    });

                    if (signupError) {
                        console.log('⚠️ 개발자 계정 이미 존재하거나 생성 실패:', signupError.message);
                    } else {
                        console.log('✅ 개발자 테스트 계정 생성 완료');
                    }

                } catch (error) {
                    console.error('💥 개발자 계정 생성 오류:', error);
                }
            }

            // 비밀번호 찾기 처리
            async handleForgotPassword(e) {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value.trim();

                // 이전 오류 메시지 숨기기
                this.hideForgotError();

                if (!email) {
                    this.showForgotError('이메일을 입력해주세요.');
                    return;
                }

                try {
                    console.log('📧 비밀번호 재설정 이메일 전송 중:', email);

                    const { data, error } = await this.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: `${window.location.origin}?reset-password=true`
                    });

                    if (error) {
                        if (error.message.includes('Email not confirmed')) {
                            this.showForgotError('이메일 인증이 되지 않은 계정입니다.');
                        } else if (error.message.includes('Invalid email')) {
                            this.showForgotError('올바른 이메일 주소를 입력해주세요.');
                        } else {
                            this.showForgotError(error.message || '비밀번호 재설정 이메일 전송에 실패했습니다.');
                        }
                        return;
                    }

                    console.log('✅ 비밀번호 재설정 이메일 전송 성공');
                    this.hideForgotPasswordModal();
                    this.showSuccess('비밀번호 재설정 이메일을 전송했습니다. 이메일을 확인해주세요.');

                } catch (error) {
                    console.error('Forgot password error:', error);
                    this.showForgotError(error.message || '비밀번호 재설정 이메일 전송에 실패했습니다.');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new BabyFacePredictor();

            // 이메일 확인 완료 또는 비밀번호 재설정 URL 파라미터 확인
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('confirmed') === 'true') {
                window.app.showSuccess('이메일 인증이 완료되었습니다! 이제 로그인할 수 있습니다.');
                // URL에서 파라미터 제거
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('reset-password') === 'true') {
                window.app.showSuccess('비밀번호가 재설정되었습니다! 새 비밀번호로 로그인해주세요.');
                // URL에서 파라미터 제거
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>

