<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 아기 얼굴 예측 프로그램</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 기본 & 폰트 설정 */
        :root {
            --color-primary: #4f46e5;
            --color-primary-hover: #4338ca;
            --color-secondary: #10b981;
            --color-background: #f9fafb;
            --color-surface: #ffffff;
            --color-text-primary: #1f2937;
            --color-text-secondary: #6b7280;
            --color-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            margin: 0;
        }

        /* 레이아웃 */
        .container-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 80rem; /* Increased max-width */
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .main-card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            box-shadow: var(--shadow-xl);
            padding: 1.5rem;
        }

        /* 헤더 */
        h1 {
            font-size: 2.25rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            letter-spacing: -0.025em;
        }
        h1 .fa-baby {
            color: #ec4899;
        }
        h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* API 키 섹션 */
        #api-key-section {
            padding: 2rem;
            margin-bottom: 2rem;
        }
        #api-key-section .fa-key { color: var(--color-primary); }
        #api-key-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #api-key-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        #save-api-key {
            width: 100%;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #save-api-key:hover {
            background-color: var(--color-primary-hover);
        }

        /* 모드 선택 버튼 */
        .mode-selector {
            display: flex;
            justify-content: center;
            background-color: #e5e7eb;
            padding: 0.375rem;
            border-radius: 9999px;
            width: 100%;
            max-width: 24rem;
            margin: 0 auto 2rem auto;
        }
        .mode-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 9999px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            color: var(--color-text-secondary);
        }
        .mode-btn.active {
            background-color: var(--color-surface);
            color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        /* 업로드 섹션 */
        .upload-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-bottom: 2rem; }
        @media (min-width: 1024px) { .upload-grid { grid-template-columns: 1fr 1fr; } }
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            transition: border-color 0.2s;
        }
        .upload-area:hover { border-color: var(--color-primary); }
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
        }
        .upload-label .fa-cloud-upload-alt { color: #9ca3af; font-size: 2.25rem; margin-bottom: 1rem; }
        .hidden { display: none; }
        .preview-container {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .preview-item {
            position: relative;
            background: #f3f4f6;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        .preview-content { padding: 0.5rem; }
        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .remove-btn:hover { background-color: rgba(239, 68, 68, 0.8); }

        /* 설정 섹션 */
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border); }
        @media (min-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; gap: 2.5rem; } }
        
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .radio-input {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            margin-right: 0.5rem;
            cursor: pointer;
            position: relative;
            transition: border-color 0.2s;
        }
        .radio-input:checked { border-color: var(--color-primary); }
        .radio-input:checked::after {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: var(--color-primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .generation-btn-group { display: flex; gap: 0.5rem; padding: 0.25rem; background-color: #e5e7eb; border-radius: 0.5rem; }
        .generation-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: none;
            background-color: transparent;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
        }
        .generation-btn.active { background-color: white; color: var(--color-primary); box-shadow: var(--shadow-sm); }
        
        .preset-age-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--color-border);
            background-color: white;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preset-age-btn.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .slider {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-lg);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-lg);
        }
        
        .prediction-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .prediction-option input[type="radio"] { margin-right: 1rem; }
        .prediction-option:has(input:checked) {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }

        #face-visualizer { background-color: #f9fafb; border-radius: 0.5rem; box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05); padding: 1rem; min-height: 16rem; display: flex; align-items: center; justify-content: center; }
        .feature-highlight { opacity: 0; transition: opacity 0.3s; fill: transparent; }
        .feature-highlight.active { opacity: 0.5; }
        .detailed-slider-item { padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .detailed-slider-item.highlighted { background-color: #eff6ff; }
        .detailed-slider-label { display: block; font-weight: 500; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .detailed-percentages { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem; }

        /* 생성 버튼 */
        .generate-button {
            padding: 0.875rem 2rem;
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-lg);
            display: inline-flex;
            align-items: center;
        }
        .generate-button:hover:not(:disabled) {
            background-color: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }
        .generate-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            box-shadow: none;
        }
        #error-message { color: #ef4444; margin-top: 1rem; font-weight: 500; }

        /* 결과 모달 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-text-secondary);
            border: none;
            background: none;
            cursor: pointer;
        }
        .loading-state, .error-state { text-align: center; padding: 2rem; }
        .spinner {
            width: 56px;
            height: 56px;
            border: 5px solid var(--color-border);
            border-bottom-color: var(--color-primary);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .results-grid {
            display: grid;
            gap: 1.5rem;
        }
        .results-grid.multiple { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .results-grid.single { display: flex; justify-content: center; }
        .results-grid.single .result-item { max-width: 512px; }
        
        .result-item { background-color: #f9fafb; border-radius: var(--border-radius); overflow: hidden; }
        .result-image { width: 100%; display: block; }
        .download-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            background-color: var(--color-primary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .download-btn:hover { background-color: var(--color-primary-hover); }

        /* 초음파 비교 결과 스타일 */
        .ultrasound-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        .ultrasound-comparison .comparison-section {
            background-color: #f9fafb;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }
        .ultrasound-comparison .comparison-header {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .ultrasound-comparison .comparison-image {
            width: 100%;
            display: block;
            aspect-ratio: 1;
            object-fit: cover;
        }
        .ultrasound-comparison .comparison-footer {
            padding: 0.75rem;
            text-align: center;
        }
        .ultrasound-comparison .download-btn {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .modal-actions { margin-top: 1.5rem; text-align: center; }
        .btn-secondary {
            padding: 0.5rem 1rem;
            background: var(--color-border);
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-wrapper">
        <div class="container">
            <!-- Header -->
            <header>
                <h1>
                    <i class="fas fa-baby"></i>
                    AI 아기 얼굴 예측 프로그램
                </h1>
                <p style="margin-top: 0.75rem; font-size: 1.125rem; color: var(--color-text-secondary);">당신의 미래 아기는 어떤 모습일까요?</p>
            </header>

            <!-- API Key Input (Initially shown) -->
            <div id="api-key-section" class="main-card">
                <h3>
                    <i class="fas fa-key mr-2"></i>
                    Google Gemini API 키를 입력하세요
                </h3>
                <div style="max-width: 28rem; margin: 0 auto;">
                    <input type="password" id="api-key-input" placeholder="이곳에 Gemini API 키를 붙여넣으세요...">
                    <button id="save-api-key">API 키 저장하기</button>
                    <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.5rem; text-align: center;">
                        API 키는 서버로 전송되지 않고 사용자의 브라우저에만 안전하게 저장됩니다.
                    </p>
                </div>
            </div>

            <!-- Main App (Initially hidden) -->
            <main id="main-app" class="main-card" style="display: none;">
                <!-- API Key Status -->
                <div id="api-status" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding: 0.75rem; background-color: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 0.5rem;">
                    <span style="color: #065f46; font-weight: 500;">
                        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>API 키가 연결되었습니다.
                    </span>
                    <button id="change-api-key" style="color: #047857; background: none; border: none; cursor: pointer; font-size: 0.875rem;">
                        키 변경
                    </button>
                </div>

                <!-- Upload Mode Selection -->
                <div class="mb-8">
                    <h3>사진을 어떻게 업로드 하시겠어요?</h3>
                    <div class="mode-selector" style="max-width: 36rem;">
                        <button id="ultrasound-mode" class="mode-btn">초음파 사진</button>
                        <button id="separate-mode" class="mode-btn active">부모님 각각</button>
                        <button id="together-mode" class="mode-btn">부모님 함께</button>
                    </div>
                </div>

                <!-- Photo Upload Sections -->
                <div id="ultrasound-upload" style="max-width: 42rem; margin: 0 auto 2rem auto; display: none;">
                    <div class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">초음파 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="ultrasound-files" multiple accept="image/*" class="hidden">
                            <label for="ultrasound-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">초음파 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">아기의 3D/4D 초음파 사진을 업로드하세요</span>
                            </label>
                        </div>
                        <div id="ultrasound-previews" class="preview-container"></div>
                    </div>
                </div>

                <div id="separate-upload" class="upload-grid">
                    <div id="father-upload" class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">아빠 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="father-files" multiple accept="image/*" class="hidden">
                            <label for="father-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">아빠 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="father-previews" class="preview-container"></div>
                    </div>

                    <div id="mother-upload" class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">엄마 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="mother-files" multiple accept="image/*" class="hidden">
                            <label for="mother-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">엄마 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="mother-previews" class="preview-container"></div>
                    </div>
                </div>

                <div id="together-upload" style="max-width: 42rem; margin: 0 auto 2rem auto; display: none;">
                    <div class="upload-section">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">부모님이 함께 나온 사진</h3>
                        <div class="upload-area">
                            <input type="file" id="together-files" multiple accept="image/*" class="hidden">
                            <label for="together-files" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span style="font-size: 1.125rem; color: #4b5563;">부모님 사진 선택</span>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">여러 장을 업로드할 수 있습니다</span>
                            </label>
                        </div>
                        <div id="together-previews" class="preview-container"></div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-grid">
                    <!-- Family Details -->
                    <div class="space-y-6">
                        <h3 style="text-align: left;">가족 정보 설정</h3>

                        <!-- Baby Info -->
                        <div style="space-y: 1rem; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                            <h4 style="font-weight: 500; color: var(--color-text-secondary); font-size: 0.875rem;">아기 정보</h4>
                            <div>
                                <label for="child-number" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">몇 번째 아이인가요?</label>
                                <input type="number" id="child-number" value="1" min="1" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">성별</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="gender" value="Male" class="radio-input">
                                        <span>남자</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="gender" value="Female" checked class="radio-input">
                                        <span>여자</span>
                                    </label>
                                </div>
                            </div>
                             <div>
                                <label for="ethnicity" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">인종</label>
                                <input type="text" id="ethnicity" class="form-input" placeholder="예: 동아시아인, 백인">
                            </div>
                            <div>
                                <label for="nationality" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">국적</label>
                                <input type="text" id="nationality" class="form-input" placeholder="예: 한국인, 미국인">
                            </div>

                            <!-- Generation Mode -->
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.5rem;">생성 옵션</label>
                                <div class="generation-btn-group">
                                    <button id="single-age-btn" class="generation-btn active">특정 나이</button>
                                    <button id="age-progression-btn" class="generation-btn">성장 과정</button>
                                </div>
                            </div>

                            <!-- Single Age Options -->
                            <div id="single-age-options">
                                <div style="margin-bottom: 1rem;">
                                    <label for="baby-age" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">나이</label>
                                    <select id="baby-age" class="form-input">
                                        <option value="Newborn">신생아</option>
                                        <option value="1 year old">1살</option>
                                        <option value="2 years old">2살</option>
                                        <option value="custom">직접 입력</option>
                                    </select>
                                    <div id="custom-age-input" style="display: none;">
                                        <input type="number" id="custom-age" placeholder="나이를 숫자로 입력" class="form-input" style="margin-top: 0.5rem;">
                                    </div>
                                </div>
                                <div>
                                    <label for="num-images" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">생성할 사진 수 (1-4)</label>
                                    <input type="number" id="num-images" value="1" min="1" max="4" class="form-input">
                                </div>
                            </div>

                            <!-- Age Progression Options -->
                            <div id="age-progression-options" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">생성할 나이 선택</label>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin-bottom: 0.5rem;">원하는 나이를 모두 선택하세요.</p>
                                    <div id="preset-ages" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <!-- Preset age buttons will be inserted here -->
                                    </div>
                                </div>
                                <div>
                                    <label for="age-progression-count" style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.25rem;">나이별 사진 수 (1-2)</label>
                                    <input type="number" id="age-progression-count" value="1" min="1" max="2" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Type -->
                    <div class="space-y-4">
                        <h3 style="text-align: left;">닮은꼴 설정</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background-color: #f3f4f6; border-radius: 0.5rem;">
                            <label class="prediction-option">
                                <input type="radio" name="comparison-type" value="simple" checked>
                                <div>
                                    <span style="font-weight: 500;">단순 설정</span>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary);">전체적으로 누구를 닮을지 비율로 조절합니다.</p>
                                </div>
                            </label>
                            <label class="prediction-option">
                                <input type="radio" name="comparison-type" value="detailed">
                                <div>
                                    <span style="font-weight: 500;">상세 설정</span>
                                    <p style="font-size: 0.75rem; color: var(--color-text-secondary);">눈, 코, 입 등 부위별로 닮은 정도를 조절합니다.</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="padding: 0.75rem; background-color: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                            <div id="simple-resemblance">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4b5563; margin-bottom: 0.5rem;">전체적인 닮음</label>
                                <input type="range" id="simple-slider" min="0" max="100" value="50" class="slider">
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem;">
                                    <span id="dad-percentage">아빠: 50%</span>
                                    <span id="mom-percentage">엄마: 50%</span>
                                </div>
                            </div>
    
                            <div id="detailed-resemblance" style="display: none;">
                                <div id="detailed-sliders" style="space-y: 0.75rem; max-height: 20rem; overflow-y: auto; padding-right: 0.5rem;">
                                    <!-- Detailed sliders will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Facial Feature Visualizer -->
                        <div id="face-visualizer" style="display: none;">
                            <svg id="face-svg" viewBox="0 0 200 200" style="width: 100%; max-width: 16rem; aspect-ratio: 1 / 1;">
                                <!-- Face base -->
                                <path d="M 100, 190 C 40, 190, 10, 150, 10, 100 C 10, 50, 40, 10, 100, 10 C 160, 10, 190, 50, 190, 100 C 190, 150, 160, 190, 100, 190 Z" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />

                                <!-- Highlight areas -->
                                <g id="highlight-areas">
                                    <path id="forehead-highlight" d="M 40, 60 Q 100, 30, 160, 60 L 160, 20 Q 100, 5, 40, 20 Z" class="feature-highlight" />
                                    <path id="eyebrows-highlight" d="M 55, 65 Q 75, 60, 95, 65 L 105, 65 Q 125, 60, 145, 65 L 140, 75 Q 125, 70, 110, 75 L 90, 75 Q 75, 70, 60, 75 Z" class="feature-highlight" />
                                    <path id="glabella-highlight" d="M 90, 80 L 110, 80 L 110, 95 L 90, 95 Z" class="feature-highlight" />
                                    <ellipse id="eyes-highlight" cx="100" cy="90" rx="45" ry="12" class="feature-highlight" />
                                    <path id="underEyes-highlight" d="M 55, 100 Q 100, 108, 145, 100 L 140, 105 Q 100, 113, 60, 105 Z" class="feature-highlight" />
                                    <path id="temples-highlight" d="M 20, 70 L 40, 70 L 40, 130 L 20, 130 Z M 160, 70 L 180, 70 L 180, 130 L 160, 130 Z" class="feature-highlight" />
                                    <path id="nose-highlight" d="M 90, 100 L 110, 100 L 105, 135 L 95, 135 Z" class="feature-highlight" />
                                    <path id="nasolabialArea-highlight" d="M 80, 120 Q 90, 140, 85, 150 L 75, 150 Q 80, 135, 70, 120 Z M 120, 120 Q 110, 140, 115, 150 L 125, 150 Q 120, 135, 130, 120 Z" class="feature-highlight" />
                                    <path id="cheeks-highlight" d="M 40, 110 C 60, 150, 80, 150, 80, 120 L 40, 110 Z M 160, 110 C 140, 150, 120, 150, 120, 120 L 160, 110 Z" class="feature-highlight" />
                                    <path id="cheekbones-highlight" d="M 30, 90 C 50, 100, 70, 110, 70, 90 Z M 170, 90 C 150, 100, 130, 110, 130, 90 Z" class="feature-highlight" />
                                    <path id="mouth-highlight" d="M 80, 155 Q 100, 165, 120, 155 Q 100, 170, 80, 155 Z" class="feature-highlight" />
                                    <path id="jawline-highlight" d="M 50, 160 C 100, 190, 150, 160, 150, 160 L 100, 195 Z" class="feature-highlight" />
                                    <path id="ears-highlight" d="M 25, 80 Q 5, 100, 25, 120 L 20, 120 Q 0, 100, 20, 80 Z M 175, 80 Q 195, 100, 175, 120 L 180, 120 Q 200, 100, 180, 80 Z" class="feature-highlight" />
                                </g>

                                <!-- Facial features -->
                                <g id="facial-features">
                                    <path d="M 25, 80 Q 5, 100, 25, 120" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />
                                    <path d="M 175, 80 Q 195, 100, 175, 120" fill="#FFDFC4" stroke="#4A4A4A" stroke-width="1.5" />
                                    <ellipse cx="75" cy="90" rx="15" ry="10" fill="white" stroke="#4A4A4A" stroke-width="1.5" />
                                    <circle cx="75" cy="90" r="5" fill="#4A4A4A" />
                                    <ellipse cx="125" cy="90" rx="15" ry="10" fill="white" stroke="#4A4A4A" stroke-width="1.5" />
                                    <circle cx="125" cy="90" r="5" fill="#4A4A4A" />
                                    <path d="M 60, 70 Q 75, 65, 90, 70" fill="none" stroke="#4A4A4A" stroke-width="2.5" stroke-linecap="round" />
                                    <path d="M 110, 70 Q 125, 65, 140, 70" fill="none" stroke="#4A4A4A" stroke-width="2.5" stroke-linecap="round" />
                                    <path d="M 95, 110 C 100, 115, 105, 115, 105, 110" fill="none" stroke="#4A4A4A" stroke-width="1.5" stroke-linecap="round" />
                                    <path d="M 85, 155 Q 100, 160, 115, 155" fill="none" stroke="#4A4A4A" stroke-width="2" stroke-linecap="round" />
                                </g>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div style="text-align: center; padding-top: 2rem; border-top: 1px solid var(--color-border);">
                    <button id="generate-btn" class="generate-button" disabled>
                        <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
                        <span>아기 얼굴 예측하기</span>
                    </button>
                    <div id="error-message" style="display: none;"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-confirmation" class="modal-close">&times;</button>
            <div style="text-align: center; margin-bottom: 2rem;">
                <i class="fas fa-baby" style="color: #ec4899; font-size: 2.5rem; margin-bottom: 1rem;"></i>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">생성 요청 확인</h2>
                <p style="color: var(--color-text-secondary); margin-top: 0.5rem;">아래 설정이 맞는지 확인해주세요.</p>
            </div>

            <div id="request-summary" style="background-color: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--color-border);">
                <!-- Summary content will be inserted here -->
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="cancel-generation" class="btn-secondary" style="padding: 0.75rem 1.5rem; font-weight: 500;">
                    <i class="fas fa-times" style="margin-right: 0.5rem;"></i>취소
                </button>
                <button id="confirm-generation" class="generate-button" style="padding: 0.75rem 2rem;">
                    <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>생성하기
                </button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-modal" class="modal-close">&times;</button>
            <div id="result-container">
                <!-- Loading state -->
                <div id="loading-state" class="loading-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: var(--color-text-secondary); font-weight: 500;">AI가 아기의 얼굴을 만들고 있어요...</p>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 0.25rem;">잠시만 기다려주세요.</p>
                </div>

                <!-- Error state -->
                <div id="error-state" class="error-state" style="display: none;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 2.25rem; margin-bottom: 1rem;"></i>
                    <p style="font-weight: bold; color: #ef4444;">이미지 생성 실패</p>
                    <p id="error-details" style="font-size: 0.875rem; margin-top: 0.25rem; color: #f87171; white-space: pre-wrap;"></p>
                </div>

                <!-- Results -->
                <div id="results-grid" style="display: none;">
                    <!-- Generated images will be inserted here -->
                </div>
            </div>

            <div class="modal-actions">
                <button id="close-results" class="btn-secondary">닫기</button>
            </div>
        </div>
    </div>

    <script>
        // AI Baby Face Predictor - Vanilla JavaScript Implementation
        class BabyFacePredictor {
            constructor() {
                this.apiKey = localStorage.getItem('geminiApiKey') || '';
                this.inputMode = 'separate';
                this.generationMode = 'singleAge';
                this.comparisonType = 'simple';

                // 이미지 저장소
                this.fatherImages = [];
                this.motherImages = [];
                this.togetherImages = [];
                this.ultrasoundImages = [];

                // 설정
                this.settings = {
                    ethnicity: '',
                    nationality: '',
                    childNumber: 1,
                    gender: 'Female',
                    babyAge: 'Newborn',
                    customAge: '',
                    numberOfImages: 1,
                    ageProgressionCount: 1,
                    selectedPresetAges: [],
                    simplePercentages: { mom: 50, dad: 50 },
                    detailedPercentages: this.initializeDetailedPercentages()
                };

                this.presetAges = [
                    '3 months old', '6 months old', '1 year old', '2 years old',
                    '3 years old', '4 years old', '5 years old'
                ];

                this.facialFeatures = [
                    { key: 'forehead', label: '이마', color: '#ff6961' },
                    { key: 'eyebrows', label: '눈썹', color: '#ffb480' },
                    { key: 'glabella', label: '미간', color: '#f8f38d' },
                    { key: 'eyes', label: '눈', color: '#42d6a4' },
                    { key: 'underEyes', label: '애교살', color: '#08cad1' },
                    { key: 'temples', label: '관자놀이', color: '#59adf6' },
                    { key: 'nose', label: '코', color: '#9d94ff' },
                    { key: 'nasolabialArea', label: '코 옆', color: '#c780e8' },
                    { key: 'cheeks', label: '뺨', color: '#ff92c2' },
                    { key: 'cheekbones', label: '광대뼈', color: '#a2d2ff' },
                    { key: 'mouth', label: '입', color: '#ffb3de' },
                    { key: 'jawline', label: '턱선/턱', color: '#ffdfb8' },
                    { key: 'ears', label: '귀', color: '#b0e0e6' }
                ];

                this.isLoading = false;
                this.currentHighlightedFeature = null;

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkApiKey();
                this.createPresetAgeButtons();
                this.createDetailedSliders();
                this.updateUI();
            }

            initializeDetailedPercentages() {
                const percentages = {};
                this.facialFeatures?.forEach(feature => {
                    percentages[feature.key] = { mom: 50, dad: 50 };
                }) || {};
                return percentages;
            }

            setupEventListeners() {
                // API 키 관리
                document.getElementById('save-api-key').addEventListener('click', () => this.saveApiKey());
                document.getElementById('change-api-key').addEventListener('click', () => this.changeApiKey());
                document.getElementById('api-key-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.saveApiKey();
                });

                // 모드 선택
                document.getElementById('ultrasound-mode').addEventListener('click', () => this.setInputMode('ultrasound'));
                document.getElementById('separate-mode').addEventListener('click', () => this.setInputMode('separate'));
                document.getElementById('together-mode').addEventListener('click', () => this.setInputMode('together'));

                // 파일 업로드
                document.getElementById('father-files').addEventListener('change', (e) => this.handleFileUpload(e, 'father'));
                document.getElementById('mother-files').addEventListener('change', (e) => this.handleFileUpload(e, 'mother'));
                document.getElementById('together-files').addEventListener('change', (e) => this.handleFileUpload(e, 'together'));
                document.getElementById('ultrasound-files').addEventListener('change', (e) => this.handleFileUpload(e, 'ultrasound'));

                // 설정
                document.getElementById('ethnicity').addEventListener('input', (e) => this.updateSetting('ethnicity', e.target.value));
                document.getElementById('nationality').addEventListener('input', (e) => this.updateSetting('nationality', e.target.value));
                document.getElementById('child-number').addEventListener('change', (e) => this.updateSetting('childNumber', parseInt(e.target.value) || 1));

                // 성별
                document.querySelectorAll('input[name="gender"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.updateSetting('gender', e.target.value));
                });

                // 생성 모드
                document.getElementById('single-age-btn').addEventListener('click', () => this.setGenerationMode('singleAge'));
                document.getElementById('age-progression-btn').addEventListener('click', () => this.setGenerationMode('ageProgression'));

                // 나이 설정
                document.getElementById('baby-age').addEventListener('change', (e) => this.updateBabyAge(e.target.value));
                document.getElementById('custom-age').addEventListener('input', (e) => this.updateSetting('customAge', e.target.value));
                document.getElementById('num-images').addEventListener('change', (e) => this.updateSetting('numberOfImages', Math.max(1, Math.min(4, parseInt(e.target.value) || 1))));
                document.getElementById('age-progression-count').addEventListener('change', (e) => this.updateSetting('ageProgressionCount', Math.max(1, Math.min(2, parseInt(e.target.value) || 1))));

                // 비교 타입
                document.querySelectorAll('input[name="comparison-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => this.setComparisonType(e.target.value));
                });

                // 단순 닮음 슬라이더
                document.getElementById('simple-slider').addEventListener('input', (e) => this.updateSimplePercentages(parseInt(e.target.value)));

                // 생성 버튼
                document.getElementById('generate-btn').addEventListener('click', () => this.showConfirmation());

                // 확인 모달 컨트롤
                document.getElementById('close-confirmation').addEventListener('click', () => this.closeConfirmationModal());
                document.getElementById('cancel-generation').addEventListener('click', () => this.closeConfirmationModal());
                document.getElementById('confirm-generation').addEventListener('click', () => this.generateBabyFace());
                document.getElementById('confirmation-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'confirmation-modal') this.closeConfirmationModal();
                });

                // 결과 모달 컨트롤
                document.getElementById('close-modal').addEventListener('click', () => this.closeModal());
                document.getElementById('close-results').addEventListener('click', () => this.closeModal());
                document.getElementById('result-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'result-modal') this.closeModal();
                });

                // 키보드 단축키
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (document.getElementById('confirmation-modal').style.display === 'flex') {
                            this.closeConfirmationModal();
                        } else {
                            this.closeModal();
                        }
                    }
                });
            }

            checkApiKey() {
                if (this.apiKey) {
                    document.getElementById('api-key-section').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                } else {
                    document.getElementById('api-key-section').style.display = 'block';
                    document.getElementById('main-app').style.display = 'none';
                }
            }

            saveApiKey() {
                const input = document.getElementById('api-key-input');
                const key = input.value.trim();

                if (!key) {
                    this.showError('API 키를 입력해주세요.');
                    return;
                }

                this.apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                input.value = '';
                this.checkApiKey();
                this.clearError();
            }

            changeApiKey() {
                this.apiKey = '';
                localStorage.removeItem('geminiApiKey');
                this.checkApiKey();
            }

            setInputMode(mode) {
                this.inputMode = mode;
                document.getElementById('ultrasound-mode').classList.toggle('active', mode === 'ultrasound');
                document.getElementById('separate-mode').classList.toggle('active', mode === 'separate');
                document.getElementById('together-mode').classList.toggle('active', mode === 'together');
                document.getElementById('ultrasound-upload').style.display = mode === 'ultrasound' ? 'block' : 'none';
                document.getElementById('separate-upload').style.display = mode === 'separate' ? 'grid' : 'none';
                document.getElementById('together-upload').style.display = mode === 'together' ? 'block' : 'none';

                // 초음파 모드에서는 닮은꼴 설정 섹션 숨기기
                const resemblanceSection = document.querySelector('.settings-grid > div:last-child');
                if (resemblanceSection) {
                    resemblanceSection.style.display = mode === 'ultrasound' ? 'none' : 'block';
                }

                // 초음파 모드에서는 생성 버튼 텍스트 변경
                const generateBtn = document.getElementById('generate-btn');
                if (mode === 'ultrasound') {
                    generateBtn.querySelector('span').textContent = '아기 얼굴 예측하기';
                } else {
                    generateBtn.querySelector('span').textContent = '아기 얼굴 예측하기';
                }

                this.updateGenerateButton();
            }

            setGenerationMode(mode) {
                this.generationMode = mode;
                document.getElementById('single-age-btn').classList.toggle('active', mode === 'singleAge');
                document.getElementById('age-progression-btn').classList.toggle('active', mode === 'ageProgression');
                document.getElementById('single-age-options').style.display = mode === 'singleAge' ? 'block' : 'none';
                document.getElementById('age-progression-options').style.display = mode === 'ageProgression' ? 'block' : 'none';
                this.updateGenerateButton();
            }

            setComparisonType(type) {
                this.comparisonType = type;
                document.getElementById('simple-resemblance').style.display = type === 'simple' ? 'block' : 'none';
                document.getElementById('detailed-resemblance').style.display = type === 'detailed' ? 'block' : 'none';
                document.getElementById('face-visualizer').style.display = type === 'detailed' ? 'flex' : 'none';
            }

            updateBabyAge(age) {
                this.updateSetting('babyAge', age);
                document.getElementById('custom-age-input').style.display = age === 'custom' ? 'block' : 'none';
            }

            updateSetting(key, value) {
                this.settings[key] = value;
                this.updateGenerateButton();
            }

            updateSimplePercentages(momPercentage) {
                this.settings.simplePercentages = {
                    mom: momPercentage,
                    dad: 100 - momPercentage
                };
                document.getElementById('mom-percentage').textContent = `엄마: ${momPercentage}%`;
                document.getElementById('dad-percentage').textContent = `아빠: ${100 - momPercentage}%`;
            }

            createPresetAgeButtons() {
                const container = document.getElementById('preset-ages');
                container.innerHTML = '';
                const ageDisplayMap = {
                    '3 months old': '3개월', '6 months old': '6개월', '1 year old': '1살', '2 years old': '2살',
                    '3 years old': '3살', '4 years old': '4살', '5 years old': '5살'
                };
                this.presetAges.forEach(age => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'preset-age-btn';
                    button.textContent = ageDisplayMap[age] || age;
                    button.addEventListener('click', () => this.togglePresetAge(age));
                    container.appendChild(button);
                });
            }

            togglePresetAge(age) {
                const index = this.settings.selectedPresetAges.indexOf(age);
                if (index > -1) {
                    this.settings.selectedPresetAges.splice(index, 1);
                } else {
                    this.settings.selectedPresetAges.push(age);
                }
                document.querySelectorAll('.preset-age-btn').forEach((btn, i) => {
                    const ageValue = this.presetAges[i];
                    btn.classList.toggle('selected', this.settings.selectedPresetAges.includes(ageValue));
                });
                this.updateGenerateButton();
            }

            createDetailedSliders() {
                const container = document.getElementById('detailed-sliders');
                container.innerHTML = '';
                this.facialFeatures.forEach(feature => {
                    const sliderDiv = document.createElement('div');
                    sliderDiv.className = 'detailed-slider-item';
                    sliderDiv.dataset.feature = feature.key;
                    sliderDiv.innerHTML = `
                        <label class="detailed-slider-label">${feature.label}</label>
                        <input type="range" min="0" max="100" value="50" class="slider" data-feature="${feature.key}">
                        <div class="detailed-percentages">
                            <span class="dad-percent">아빠: 50%</span>
                            <span class="mom-percent">엄마: 50%</span>
                        </div>
                    `;
                    const slider = sliderDiv.querySelector('.slider');
                    slider.addEventListener('input', (e) => this.updateDetailedPercentage(feature.key, parseInt(e.target.value)));
                    sliderDiv.addEventListener('mouseenter', () => this.highlightFeature(feature.key, feature.color));
                    sliderDiv.addEventListener('mouseleave', () => this.highlightFeature(null));
                    container.appendChild(sliderDiv);
                });
            }

            updateDetailedPercentage(featureKey, momPercentage) {
                const dadPercentage = 100 - momPercentage;
                this.settings.detailedPercentages[featureKey] = { mom: momPercentage, dad: dadPercentage };
                const sliderItem = document.querySelector(`[data-feature="${featureKey}"]`);
                if (sliderItem) {
                    sliderItem.querySelector('.mom-percent').textContent = `엄마: ${momPercentage}%`;
                    sliderItem.querySelector('.dad-percent').textContent = `아빠: ${dadPercentage}%`;
                }
            }

            highlightFeature(featureKey, color = null) {
                document.querySelectorAll('.detailed-slider-item').forEach(item => item.classList.remove('highlighted'));
                document.querySelectorAll('.feature-highlight').forEach(highlight => {
                    highlight.classList.remove('active');
                    highlight.style.fill = 'transparent';
                });
                if (featureKey) {
                    const sliderItem = document.querySelector(`[data-feature="${featureKey}"]`);
                    if (sliderItem) sliderItem.classList.add('highlighted');
                    const faceHighlight = document.getElementById(`${featureKey}-highlight`);
                    if (faceHighlight) {
                        faceHighlight.classList.add('active');
                        faceHighlight.style.fill = color || '#4f46e5';
                    }
                }
                this.currentHighlightedFeature = featureKey;
            }

            async handleFileUpload(event, type) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                const targetArray = type === 'father' ? this.fatherImages :
                                  type === 'mother' ? this.motherImages :
                                  type === 'together' ? this.togetherImages :
                                  this.ultrasoundImages;
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        try {
                            const imageData = await this.processImageFile(file);
                            const imageWithAge = { id: `${Date.now()}-${Math.random()}`, imageData, age: '', fatherAge: '', motherAge: '' };
                            targetArray.push(imageWithAge);
                        } catch (error) {
                            console.error('이미지 처리 오류:', error);
                            this.showError('이미지 파일 처리에 실패했습니다.');
                        }
                    }
                }
                this.renderPreviews(type);
                this.updateGenerateButton();
                event.target.value = '';
            }

            async processImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const result = e.target.result;
                        const base64String = result.split(',')[1];
                        resolve({ base64: base64String, mimeType: file.type, preview: result });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            renderPreviews(type) {
                const container = document.getElementById(`${type}-previews`);
                const images = type === 'father' ? this.fatherImages :
                              type === 'mother' ? this.motherImages :
                              type === 'together' ? this.togetherImages :
                              this.ultrasoundImages;
                container.innerHTML = '';
                images.forEach(image => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'preview-item';
                    const img = document.createElement('img');
                    img.src = image.imageData.preview;
                    img.className = 'preview-image';
                    img.alt = 'preview';
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'preview-content';
                    if (type === 'ultrasound') {
                        contentDiv.innerHTML = `
                            <div>
                                <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">초음파 사진</label>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0.25rem 0 0 0;">3D/4D 초음파 이미지</p>
                            </div>
                        `;
                    } else if (type === 'together') {
                        contentDiv.innerHTML = `
                            <div style="display: flex; gap: 0.5rem;">
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">아빠 나이</label>
                                    <input type="number" value="${image.fatherAge}" placeholder="예: 32" class="form-input" onchange="app.updateImageAge('${image.id}', 'fatherAge', this.value)">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">엄마 나이</label>
                                    <input type="number" value="${image.motherAge}" placeholder="예: 30" class="form-input" onchange="app.updateImageAge('${image.id}', 'motherAge', this.value)">
                                </div>
                            </div>
                        `;
                    } else {
                        contentDiv.innerHTML = `
                            <div>
                                <label style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">사진 속 나이</label>
                                <input type="number" value="${image.age}" placeholder="예: 28" class="form-input" onchange="app.updateImageAge('${image.id}', 'age', this.value)">
                            </div>
                        `;
                    }
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    removeBtn.onclick = () => this.removeImage(image.id, type);
                    previewDiv.appendChild(img);
                    previewDiv.appendChild(contentDiv);
                    previewDiv.appendChild(removeBtn);
                    container.appendChild(previewDiv);
                });
            }

            updateImageAge(imageId, ageType, value) {
                const allImages = [...this.fatherImages, ...this.motherImages, ...this.togetherImages, ...this.ultrasoundImages];
                const image = allImages.find(img => img.id === imageId);
                if (image) image[ageType] = value;
            }

            removeImage(imageId, type) {
                if (type === 'father') this.fatherImages = this.fatherImages.filter(img => img.id !== imageId);
                else if (type === 'mother') this.motherImages = this.motherImages.filter(img => img.id !== imageId);
                else if (type === 'together') this.togetherImages = this.togetherImages.filter(img => img.id !== imageId);
                else if (type === 'ultrasound') this.ultrasoundImages = this.ultrasoundImages.filter(img => img.id !== imageId);
                this.renderPreviews(type);
                this.updateGenerateButton();
            }

            updateGenerateButton() {
                const button = document.getElementById('generate-btn');
                const hasRequiredImages = (this.inputMode === 'separate' && this.fatherImages.length > 0 && this.motherImages.length > 0) ||
                                        (this.inputMode === 'together' && this.togetherImages.length > 0) ||
                                        (this.inputMode === 'ultrasound' && this.ultrasoundImages.length > 0);
                const hasAgeProgression = this.generationMode !== 'ageProgression' || this.settings.selectedPresetAges.length > 0;
                const isEnabled = hasRequiredImages && hasAgeProgression && !this.isLoading;
                button.disabled = !isEnabled;
                button.querySelector('span').textContent = this.isLoading ? '생성 중...' : "아기 얼굴 예측하기";
            }

            showConfirmationModal() {
                // 요약 내용 생성
                const summary = this.generateRequestSummary();
                document.getElementById('request-summary').innerHTML = summary;

                // 확인 모달 표시
                document.getElementById('confirmation-modal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            generateRequestSummary() {
                let html = '<div style="display: grid; gap: 1.5rem;">';

                // 사진 정보
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">📷 업로드된 사진</h4>';
                if (this.inputMode === 'separate') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">아빠 사진 ${this.fatherImages.length}장, 엄마 사진 ${this.motherImages.length}장</p>`;
                } else if (this.inputMode === 'together') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">부모님 함께 사진 ${this.togetherImages.length}장</p>`;
                } else if (this.inputMode === 'ultrasound') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">초음파 사진 ${this.ultrasoundImages.length}장</p>`;
                }
                html += '</div>';

                // 아기 정보
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">👶 아기 정보</h4>';
                const childNumber = this.settings.childNumber;
                const ordinal = childNumber === 1 ? '첫' : childNumber === 2 ? '둘' : childNumber === 3 ? '셋' : `${childNumber}번`;
                const genderText = this.settings.gender === 'Male' ? '남자아이' : '여자아이';
                html += `<p style="margin: 0; font-size: 0.875rem;">${ordinal}째 ${genderText}`;
                if (this.settings.ethnicity) html += `, ${this.settings.ethnicity}`;
                if (this.settings.nationality) html += `, ${this.settings.nationality}`;
                html += '</p></div>';

                // 생성 설정
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">⚙️ 생성 설정</h4>';
                if (this.generationMode === 'singleAge') {
                    const age = this.settings.babyAge === 'custom' ? `${this.settings.customAge}살` :
                              this.settings.babyAge === 'Newborn' ? '신생아' :
                              this.settings.babyAge.replace(' years old', '살').replace(' year old', '살');
                    html += `<p style="margin: 0; font-size: 0.875rem;">${age} 사진 ${this.settings.numberOfImages}장 생성</p>`;
                } else {
                    const ageDisplayMap = {
                        '3 months old': '3개월', '6 months old': '6개월', '1 year old': '1살',
                        '2 years old': '2살', '3 years old': '3살', '4 years old': '4살', '5 years old': '5살'
                    };
                    const selectedAgesText = this.settings.selectedPresetAges.map(age => ageDisplayMap[age] || age).join(', ');
                    const totalImages = this.settings.selectedPresetAges.length * this.settings.ageProgressionCount;
                    html += `<p style="margin: 0; font-size: 0.875rem;">성장 과정: ${selectedAgesText}</p>`;
                    html += `<p style="margin: 0; font-size: 0.875rem;">나이별 ${this.settings.ageProgressionCount}장씩, 총 ${totalImages}장 생성</p>`;
                }
                html += '</div>';

                // 닮음 설정
                html += '<div><h4 style="margin: 0 0 0.5rem 0; color: var(--color-primary); font-size: 0.875rem; font-weight: 600;">👥 닮음 설정</h4>';
                if (this.comparisonType === 'simple') {
                    html += `<p style="margin: 0; font-size: 0.875rem;">전체적으로 엄마 ${this.settings.simplePercentages.mom}%, 아빠 ${this.settings.simplePercentages.dad}%</p>`;
                } else {
                    html += '<p style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">부위별 상세 설정:</p>';
                    html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.25rem; font-size: 0.75rem; color: var(--color-text-secondary);">';
                    this.facialFeatures.forEach(feature => {
                        const percentages = this.settings.detailedPercentages[feature.key];
                        if (percentages && (percentages.mom !== 50 || percentages.dad !== 50)) {
                            html += `<div>${feature.label}: 엄마 ${percentages.mom}%, 아빠 ${percentages.dad}%</div>`;
                        }
                    });
                    html += '</div>';
                }
                html += '</div>';

                html += '</div>';
                return html;
            }

            closeConfirmationModal() {
                document.getElementById('confirmation-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            showConfirmation() {
                // 입력 검증
                if ((this.inputMode === 'separate' && (this.fatherImages.length === 0 || this.motherImages.length === 0)) ||
                    (this.inputMode === 'together' && this.togetherImages.length === 0) ||
                    (this.inputMode === 'ultrasound' && this.ultrasoundImages.length === 0)) {
                    this.showError('각 카테고리에 최소 한 장의 사진을 업로드해주세요.');
                    return;
                }
                if (this.generationMode === 'ageProgression' && this.settings.selectedPresetAges.length === 0) {
                    this.showError('성장 과정 모드에서는 최소 한 개의 나이를 선택해야 합니다.');
                    return;
                }

                this.clearError();
                this.showConfirmationModal();
            }

            async generateBabyFace() {
                if (this.isLoading) return;

                this.isLoading = true;
                this.closeConfirmationModal();
                this.showModal();
                this.updateGenerateButton();

                try {
                    let generatedImages = [];
                    if (this.generationMode === 'singleAge') {
                        const age = this.settings.babyAge === 'custom' ? `${this.settings.customAge} years old` : this.settings.babyAge;
                        const results = await this.callGeminiAPI({ age, numberOfImages: this.settings.numberOfImages });
                        generatedImages = results;
                    } else {
                        for (const age of this.settings.selectedPresetAges) {
                            const resultsForAge = await this.callGeminiAPI({ age, numberOfImages: this.settings.ageProgressionCount });
                            generatedImages.push(...resultsForAge.map(img => ({ src: img, age })));
                        }
                    }
                    this.displayResults(generatedImages);
                } catch (error) {
                    console.error('생성 오류:', error);
                    this.showErrorState(error.message || '아기 얼굴 생성에 실패했습니다. 다시 시도해주세요.');
                } finally {
                    this.isLoading = false;
                    this.updateGenerateButton();
                }
            }

            async callGeminiAPI(params) {
                const { age, numberOfImages } = params;
                const prompt = this.buildPrompt(age);
                const parts = [];
                if (this.inputMode === 'ultrasound' && this.ultrasoundImages.length > 0) {
                    this.ultrasoundImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: 'This is a 3D/4D ultrasound image showing the baby in the womb.' });
                    });
                } else if (this.inputMode === 'together' && this.togetherImages.length > 0) {
                    this.togetherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        let ageText = "This photo shows father and mother together";
                        if (img.fatherAge && img.motherAge) ageText += `, father around ${img.fatherAge} years old, mother around ${img.motherAge} years old.`;
                        else if (img.fatherAge) ageText += `, father around ${img.fatherAge} years old.`;
                        else if (img.motherAge) ageText += `, mother around ${img.motherAge} years old.`;
                        else ageText += '.';
                        parts.push({ text: ageText });
                    });
                } else if (this.fatherImages.length > 0 && this.motherImages.length > 0) {
                    this.fatherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: `Father at around ${img.age || 'unknown'} years old.` });
                    });
                    this.motherImages.forEach(img => {
                        parts.push({ inline_data: { data: img.imageData.base64, mime_type: img.imageData.mimeType } });
                        parts.push({ text: `Mother at around ${img.age || 'unknown'} years old.` });
                    });
                }
                parts.push({ text: prompt });
                const generatedImages = [];

                for (let i = 0; i < numberOfImages; i++) {
                    if (i > 0) await new Promise(resolve => setTimeout(resolve, 4000));

                    let success = false;
                    let lastError = null;

                    // 최대 3번 재시도
                    for (let retryCount = 0; retryCount < 3 && !success; retryCount++) {
                        if (retryCount > 0) {
                            console.log(`재시도 ${retryCount}/${numberOfImages}번째 이미지...`);
                            await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // 지연 시간 증가
                        }

                        try {
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${this.apiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts }],
                                    generationConfig: {
                                        temperature: 0.4 + (retryCount * 0.1), // 재시도마다 약간씩 변경
                                        topP: 0.8,
                                        topK: 40
                                    }
                                })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();

                                if (response.status === 429) {
                                    throw new Error(`⚠️ API 할당량 초과!\n\n무료 API 키는 요청 횟수가 제한되어 있습니다. 문제가 계속되면 다음을 시도해보세요:\n1. 24시간 후 재시도\n2. Google AI Studio에서 새 API 키 생성\n3. Google Cloud에서 유료 결제 계정 연결`);
                                }

                                if (response.status === 500) {
                                    lastError = new Error(`Google 서버 오류 (시도 ${retryCount + 1}/3). ${retryCount < 2 ? '재시도 중...' : '재시도 한계 도달.'}`);
                                    continue; // 500 에러는 재시도
                                }

                                let error;
                                try { error = JSON.parse(errorText); } catch { error = { error: { message: errorText } }; }
                                throw new Error(error.error?.message || `API 요청 실패 (${response.status})`);
                            }
                            const data = await response.json();
                            console.log('API 응답 데이터:', data); // 디버깅용

                            if (!data.candidates || data.candidates.length === 0) {
                                lastError = new Error('모델로부터 응답을 받지 못했습니다.');
                                continue; // 재시도
                            }

                            const candidate = data.candidates[0];
                            if (!candidate.content || !candidate.content.parts || candidate.content.parts.length === 0) {
                                lastError = new Error('모델 응답에 콘텐츠가 없습니다.');
                                continue; // 재시도
                            }

                            const imagePart = candidate.content.parts.find(p => p.inlineData || p.inline_data);
                            if (imagePart) {
                                const inlineData = imagePart.inlineData || imagePart.inline_data;
                                generatedImages.push(`data:${inlineData.mimeType || inlineData.mime_type};base64,${inlineData.data}`);
                                success = true; // 성공!
                            } else {
                                const textPart = candidate.content.parts.find(p => p.text);
                                if (textPart) {
                                    console.warn(`시도 ${i + 1}-${retryCount + 1}: 모델이 텍스트로 응답했습니다:`, textPart.text);
                                    lastError = new Error(`모델이 이미지 대신 텍스트를 반환했습니다. (시도 ${retryCount + 1}/3)`);
                                    continue; // 재시도
                                } else {
                                    console.log('사용 가능한 parts:', candidate.content.parts);
                                    lastError = new Error('모델 응답에서 이미지를 찾을 수 없습니다.');
                                    continue; // 재시도
                                }
                            }

                        } catch (error) {
                            console.error(`재시도 ${retryCount + 1} 실패:`, error);
                            lastError = error;

                            // 치명적인 오류는 즉시 중단
                            if (error.message.includes('할당량 초과') || error.message.includes('quota')) {
                                throw error;
                            }
                        }
                    }

                    // 모든 재시도가 실패한 경우
                    if (!success) {
                        throw lastError || new Error(`${i + 1}번째 이미지 생성에 실패했습니다.`);
                    }
                }
                return generatedImages;
            }
            
            buildPrompt(age) {
                if (this.inputMode === 'ultrasound') {
                    // 초음파 모드용 특별한 프롬프트
                    const nationality = this.settings.nationality || 'Korean';
                    const gender = this.settings.gender === 'Male' ? 'male' : 'female';
                    const ethnicity = this.settings.ethnicity || '';

                    let prompt = `Analyze the uploaded ultrasound image as the primary reference for the baby's pose and angle. Generate a single, photorealistic, high-detail image of a healthy and adorable ${age} baby, perfectly matching the exact angle, orientation, and posture of the fetus in the ultrasound.

BABY SPECIFICATIONS:
- The baby should be of ${nationality} nationality
- Gender: ${gender}
- Age: ${age}`;

                    if (ethnicity) {
                        prompt += `\n- Ethnicity: ${ethnicity}`;
                    }

                    prompt += `

VISUAL REQUIREMENTS:
- The baby is dressed in a cozy, soft-knitted onesie in a delicate pastel color palette (light pinks, baby blues, and mint greens)
- The lighting should be soft, warm, and natural, as if from a nearby window, creating a gentle and loving atmosphere
- The background should be a clean, simple, and slightly out-of-focus nursery setting in complementary pastel tones
- Capture this with the quality of a professional portrait photograph, using a shallow depth of field to emphasize the baby
- The baby's skin should look soft and natural, with realistic textures
- The overall mood should be peaceful, heartwarming, and full of tenderness

CRITICAL POSITIONING:
- Maintain the EXACT same angle, head position, and facial orientation as shown in the ultrasound
- Transform the ultrasound features into a realistic baby appearance while preserving the identical pose
- Keep the same facial structure and features visible in the ultrasound

Generate only the image without any text descriptions, explanations, or confirmations. The result should be a professional-quality baby portrait that perfectly matches the ultrasound's angle and position.`;

                    return prompt;
                }

                // 기존 부모 사진 기반 프롬프트
                let prompt = `IMPORTANT: Generate only a photorealistic image. Do not provide text explanations or descriptions.

Based on the provided parent photos, create a realistic child's face photo combining their facial features.

CHILD SPECIFICATIONS:
- Gender: ${this.settings.gender === 'Male' ? 'Male' : 'Female'}
- Age: ${age}
- Birth order: ${this.settings.childNumber === 1 ? 'First child' : `${this.settings.childNumber} child`}`;

                if (this.settings.ethnicity) prompt += `\n- Ethnicity: ${this.settings.ethnicity}`;
                if (this.settings.nationality) prompt += `\n- Nationality: ${this.settings.nationality}`;

                prompt += '\n\nFACIAL FEATURE BLENDING:';
                if (this.comparisonType === 'simple') {
                    prompt += `\n- Overall appearance: ${this.settings.simplePercentages.mom}% mother, ${this.settings.simplePercentages.dad}% father`;
                } else {
                    prompt += '\nSpecific feature ratios:';
                    this.facialFeatures.forEach(feature => {
                        const percentages = this.settings.detailedPercentages[feature.key];
                        if (percentages && (percentages.mom !== 50 || percentages.dad !== 50)) {
                            prompt += `\n- ${feature.label}: ${percentages.mom}% mother, ${percentages.dad}% father`;
                        }
                    });
                }

                prompt += `\n\nGenerate a high-quality, photorealistic portrait photograph showing the child's face and upper shoulders. The image should look like a natural family photo with soft, even lighting. Do not include any text, labels, or annotations in the image.

CRITICAL: Respond with only the generated image. Do not provide text descriptions, explanations, or confirmations.`;

                return prompt;
            }

            showModal() {
                document.getElementById('result-modal').style.display = 'flex';
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'none';
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('result-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            showErrorState(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-details').textContent = message;
            }

            displayResults(images) {
                if (!images || images.length === 0) return;
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('results-grid').style.display = 'grid';
                const resultsGrid = document.getElementById('results-grid');

                if (this.inputMode === 'ultrasound') {
                    // 초음파 모드: 원본-결과 비교 뷰
                    resultsGrid.className = 'results-grid single';
                    resultsGrid.innerHTML = '';

                    images.forEach((imageData, index) => {
                        const comparisonContainer = document.createElement('div');
                        comparisonContainer.className = 'ultrasound-comparison';

                        // 원본 초음파 이미지
                        const originalSection = document.createElement('div');
                        originalSection.className = 'comparison-section';
                        originalSection.innerHTML = `
                            <div class="comparison-header">원본 초음파 사진</div>
                            <img src="${this.ultrasoundImages[0].imageData.preview}" alt="원본 초음파" class="comparison-image">
                            <div class="comparison-footer">
                                <button class="download-btn" onclick="app.downloadImage('${this.ultrasoundImages[0].imageData.preview}', 'original')">
                                    <i class="fas fa-download" style="margin-right: 0.5rem;"></i>원본 다운로드
                                </button>
                            </div>
                        `;

                        // 생성된 아기 이미지
                        const generatedSection = document.createElement('div');
                        generatedSection.className = 'comparison-section';
                        const imgSrc = typeof imageData === 'string' ? imageData : imageData.src;
                        let ageDisplay = '';
                        if (typeof imageData === 'object' && imageData.age) {
                            ageDisplay = imageData.age.replace(' old', '살').replace(' year', '살').replace(' months', '개월');
                        }
                        generatedSection.innerHTML = `
                            <div class="comparison-header">예측된 아기 모습 ${ageDisplay ? `(${ageDisplay})` : ''}</div>
                            <img src="${imgSrc}" alt="생성된 아기" class="comparison-image">
                            <div class="comparison-footer">
                                <button class="download-btn" onclick="app.downloadImage('${imgSrc}', ${index})">
                                    <i class="fas fa-download" style="margin-right: 0.5rem;"></i>결과 다운로드 ${ageDisplay ? `(${ageDisplay})` : ''}
                                </button>
                            </div>
                        `;

                        comparisonContainer.appendChild(originalSection);
                        comparisonContainer.appendChild(generatedSection);
                        resultsGrid.appendChild(comparisonContainer);
                    });
                } else {
                    // 기존 모드: 일반 그리드 뷰
                    resultsGrid.className = `results-grid ${images.length === 1 ? 'single' : 'multiple'}`;
                    resultsGrid.innerHTML = '';
                    images.forEach((imageData, index) => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        const img = document.createElement('img');
                        img.src = typeof imageData === 'string' ? imageData : imageData.src;
                        img.alt = `생성된 아기 ${index + 1}`;
                        img.className = 'result-image';
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-btn';
                        let btnText = `<i class="fas fa-download" style="margin-right: 0.5rem;"></i>다운로드`;
                        if (typeof imageData === 'object' && imageData.age) {
                            const ageDisplay = imageData.age.replace(' old', '살').replace(' year', '살').replace(' months', '개월');
                            btnText += ` (${ageDisplay})`;
                        }
                        downloadBtn.innerHTML = btnText;
                        downloadBtn.onclick = () => this.downloadImage(img.src, index);
                        resultItem.appendChild(img);
                        resultItem.appendChild(downloadBtn);
                        resultsGrid.appendChild(resultItem);
                    });
                }
            }

            downloadImage(imageDataUrl, index) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                const fileExtension = imageDataUrl.split(';')[0].split('/')[1] || 'png';

                let filename;
                if (index === 'original') {
                    filename = `ultrasound-original.${fileExtension}`;
                } else if (this.inputMode === 'ultrasound') {
                    filename = `ultrasound-prediction-${index + 1}.${fileExtension}`;
                } else {
                    filename = `baby-prediction-${index + 1}.${fileExtension}`;
                }

                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showError(message) {
                const errorElement = document.getElementById('error-message');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => this.clearError(), 5000);
            }



            clearError() {
                const errorElement = document.getElementById('error-message');
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }

            updateUI() {
                this.updateGenerateButton();
                document.querySelector('input[name="gender"][value="Female"]').checked = true;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new BabyFacePredictor();
        });
    </script>
</body>
</html>

